---
title: "Organic Food Environment Assessment"
author: "Alexandra Sadler"
date: "19/07/2024"
output: word_document
---

```{r setup, include=FALSE}
# Load necessary libraries
library(dplyr)
library(gmodels)
library(gt)
library(knitr)
library(kableExtra)
library(openxlsx)
library(readxl)
library(readr)
library(stats)
library(tidyr)

knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}

# Set working directory
setwd("C:/Users/s1985751/Documents/GitHub/fea")


# Load cleaned data
data_clean <- read.xlsx("C:/Users/s1985751/Documents/GitHub/fea/data_clean.xlsx", sheet = "data")

# Create workbook for table data
table_outputs <- createWorkbook()
saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)


```

## Descriptive Results

```{r echo = FALSE, message = FALSE, warning = FALSE}
# Generate Table 1

# Calculate total vendors per city
tab1_total_vendors <- data_clean %>%
  group_by(country, city) %>%
  summarise(total_vendors = n()) %>%
  ungroup()

# Calculate neighbourhood counts and percentages
tab1_neighbourhood_data <- data_clean %>%
  group_by(country, city, circle) %>%
  summarise(count = n()) %>%
  pivot_wider(names_from = circle, values_from = count, values_fill = list(count = 0)) %>%
  ungroup() %>%
  left_join(overall_data, by = c("country", "city")) %>%
  mutate(
    higher_perc = Higher / total_vendors,
    middle_perc = Middle / total_vendors,
    lower_perc = Lower / total_vendors
  ) %>%
  select(country, city, total_vendors, Higher, higher_perc, Middle, middle_perc, Lower, lower_perc)

# Calculate store type counts and percentages
tab1_store_data <- data_clean %>%
  group_by(country, city, vendor_type) %>%
  summarise(count = n()) %>%
  pivot_wider(names_from = vendor_type, values_from = count, values_fill = list(count = 0)) %>%
  ungroup() %>%
  left_join(overall_data, by = c("country", "city")) %>%
  mutate(
    supermarket_perc = Supermarket / total_vendors,
    mobile_vendor_perc = `Mobile vendor` / total_vendors,
    stationary_small_vendor_perc = `Stationary small local vendor` / total_vendors
  ) %>%
  select(country, city, `Mobile vendor`, mobile_vendor_perc, `Stationary small local vendor`, stationary_small_vendor_perc, Supermarket, supermarket_perc,  )


# Merge both datasets
tab1_data <- tab1_neighbourhood_data %>%
  left_join(tab1_store_data, by = c("country", "city"))


# Create the gt table
tab1 <- tab1_data %>%
  gt(rowname_col = "city", groupname_col = "country") %>%
  cols_label(
    city = "City",
    total_vendors = "Total vendors",
    Higher = "Higher",
    higher_perc = " ",
    Middle = "Middle",
    middle_perc = " ",
    Lower = "Lower",
    lower_perc = " ",
    `Mobile vendor` = "Mobile vendor",
    mobile_vendor_perc = " ",
    `Stationary small local vendor` = "Stationary small vendor",
    stationary_small_vendor_perc = " ",
    Supermarket = "Supermarket",
    supermarket_perc = " "
  ) %>%
  fmt_percent(
    columns = vars(higher_perc, middle_perc, lower_perc,
                   mobile_vendor_perc, stationary_small_vendor_perc,
                   supermarket_perc),
    decimals = 0
  ) %>%
  cols_merge(
    columns = c("Higher", "higher_perc"),
    pattern = "{1} ({2})"
  ) %>%
  cols_merge(
    columns = c("Middle", "middle_perc"),
    pattern = "{1} ({2})"
  ) %>%
  cols_merge(
    columns = c("Lower", "lower_perc"),
    pattern = "{1} ({2})"
  ) %>%
  cols_merge(
    columns = c("Mobile vendor", "mobile_vendor_perc"),
    pattern = "{1} ({2})"
  ) %>%
  cols_merge(
    columns = c("Stationary small local vendor",
                "stationary_small_vendor_perc"),
    pattern = "{1} ({2})"
  ) %>%
  cols_merge(
    columns = c("Supermarket", "supermarket_perc"),
    pattern = "{1} ({2})"
  ) %>%
  summary_rows(
    groups = everything(),
    columns = vars(total_vendors, Higher, higher_perc,
                   Middle, middle_perc,
                   Lower, lower_perc, 
                   `Mobile vendor`, mobile_vendor_perc,
                   `Stationary small local vendor`,
                   stationary_small_vendor_perc,
                   Supermarket, supermarket_perc),
    fns = list(total = ~sum(., na.rm = TRUE)),
    formatter = fmt_number,
    decimals = 0
  ) %>%
  sub_missing() 
  
# Display the table
tab1

# Note: I can't seem to get it to also have the percentage columns
# Note: Also don't know how to do a grand total - keep getting errors

# Export to table_outputs workbook

addWorksheet(table_outputs, "Table 1")
writeData(table_outputs, sheet = "Table 1", x = tab1)
saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)


```



## 1. What is the availability of organic food in urban food environments? How does this vary across different geographic and socioeconomic contexts?

### Hypothesis 1a. Organic food availability will be highest in the United Kingdom, in larger cities within a given country, and in higher-income neighbourhoods within a given city.

#### Kruskal-Wallis rank sum test

##### Overall results (variation between countries)
```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame of country and org_foods_count
kruskal_country_data <- data_clean %>%
  select(country, org_foods_count)

# Perform the Kruskal-Wallis test
result_overall <- kruskal.test(org_foods_count ~ country, data = kruskal_country_data)
  
# Display the results
print(result_overall)

```

##### Country-level results (variation between cities within a given country)

###### Brazil

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame for Brazil
brazil <- data_clean %>%
  filter(country == "Brazil")

# Create data frame of city and org_foods_count
kruskal_brazil_city_data <- brazil %>%
  select(city, org_foods_count)

# Perform the Kruskal-Wallis test
result_brazil <- kruskal.test(org_foods_count ~ city, data = kruskal_brazil_city_data)
  
# Display the results
print(result_brazil)

```

###### India

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame for India
india <- data_clean %>%
  filter(country == "India")

# Create data frame of city and org_foods_count
kruskal_india_city_data <- india %>%
  select(city, org_foods_count)

# Perform the Kruskal-Wallis test
result_india <- kruskal.test(org_foods_count ~ city, data = kruskal_india_city_data)
  
# Display the results
print(result_india)

```

###### United Kingdom

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame for India
uk <- data_clean %>%
  filter(country == "UK")

# Create data frame of city and org_foods_count
kruskal_uk_city_data <- uk %>%
  select(city, org_foods_count)

# Perform the Kruskal-Wallis test
result_uk <- kruskal.test(org_foods_count ~ city, data = kruskal_uk_city_data)
  
# Display the results
print(result_uk)

```

##### City-level results (variation between neighbourhoods within a given city)

###### Brazil: Rio de Janeiro

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame for Rio de Janeiro
rio <- data_clean %>%
  filter(city == "Rio de Janeiro")

# Create data frame of circle and org_foods_count
kruskal_rio_data <- rio %>%
  select(circle, org_foods_count)

# Perform the Kruskal-Wallis test
result_rio <- kruskal.test(org_foods_count ~ circle, data = kruskal_rio_data)
  
# Display the results
print(result_rio)

```

###### Brazil: Sao Paulo

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame for Sao Paulo
saopaulo <- data_clean %>%
  filter(city == "Sao Paolo")

# Create data frame of circle and org_foods_count
kruskal_saopaulo_data <- saopaulo %>%
  select(circle, org_foods_count)

# Perform the Kruskal-Wallis test
result_saopaulo <- kruskal.test(org_foods_count ~ circle, data = kruskal_saopaulo_data)
  
# Display the results
print(result_saopaulo)

```

###### Brazil: Sinop

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame for Sinop
sinop <- data_clean %>%
  filter(city == "Sinop")

# Create data frame of circle and org_foods_count
kruskal_sinop_data <- sinop %>%
  select(circle, org_foods_count)

# Perform the Kruskal-Wallis test
result_sinop <- kruskal.test(org_foods_count ~ circle, data = kruskal_sinop_data)
  
# Display the results
print(result_sinop)

```


###### India: Hyderabad

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame for Hyderabad
hyderabad <- data_clean %>%
  filter(city == "Hyderabad")

# Create data frame of circle and org_foods_count
kruskal_hyderabad_data <- hyderabad %>%
  select(circle, org_foods_count)

# Perform the Kruskal-Wallis test
result_hyderabad <- kruskal.test(org_foods_count ~ circle, data = kruskal_hyderabad_data)
  
# Display the results
print(result_hyderabad)

```

###### India: Latur

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame for Latur
latur <- data_clean %>%
  filter(city == "Latur")

# Create data frame of circle and org_foods_count
kruskal_latur_data <- latur %>%
  select(circle, org_foods_count)

# Perform the Kruskal-Wallis test
result_latur <- kruskal.test(org_foods_count ~ circle, data = kruskal_latur_data)
  
# Display the results
print(result_latur)

```

###### India: Visakhapatnam

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame for Visakhapatnam
visakhapatnam <- data_clean %>%
  filter(city == "Visakhapatnam")

# Create data frame of circle and org_foods_count
kruskal_visakhapatnam_data <- visakhapatnam %>%
  select(circle, org_foods_count)

# Perform the Kruskal-Wallis test
result_visakhapatnam <- kruskal.test(org_foods_count ~ circle, data = kruskal_visakhapatnam_data)
  
# Display the results
print(result_visakhapatnam)

```

###### United Kingdom: Birmingham

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame for Birmingham
birmingham <- data_clean %>%
  filter(city == "Birmingham")

# Create data frame of circle and org_foods_count
kruskal_birmingham_data <- birmingham %>%
  select(circle, org_foods_count)

# Perform the Kruskal-Wallis test
result_birmingham <- kruskal.test(org_foods_count ~ circle, data = kruskal_birmingham_data)
  
# Display the results
print(result_birmingham)

```

###### UK: Edinburgh

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame for Edinburgh
edinburgh <- data_clean %>%
  filter(city == "Edinburgh")

# Create data frame of circle and org_foods_count
kruskal_edinburgh_data <- edinburgh %>%
  select(circle, org_foods_count)

# Perform the Kruskal-Wallis test
result_edinburgh <- kruskal.test(org_foods_count ~ circle, data = kruskal_edinburgh_data)
  
# Display the results
print(result_edinburgh)

```

###### UK: London

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame for London
london <- data_clean %>%
  filter(city == "London")

# Create data frame of circle and org_foods_count
kruskal_london_data <- london %>%
  select(circle, org_foods_count)

# Perform the Kruskal-Wallis test
result_london <- kruskal.test(org_foods_count ~ circle, data = kruskal_london_data)
  
# Display the results
print(result_london)

```

##### Summary of p-values

###### Overall p-value

```{r echo = FALSE, message = FALSE, warning = FALSE}

p_values_kruskal_overall <- result_overall$p.value

print(p_values_kruskal_overall)
```


###### Country-level p-values
```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create a vector of country names
country_names <- c("Brazil","India","UK")

# Create a vector of the result object names
kruskal_country_result_names <- c("result_brazil", "result_india", "result_uk")

# Retrieve results and store in a list
kruskal_country_result_list <- mget(kruskal_country_result_names)

# Print list to confirm
print(kruskal_country_result_list)

# Extract p-values from the results
p_values_kruskal_country <- sapply(kruskal_country_result_list, function(res) res$p.value)

# Create a dataframe
p_values_kruskal_country_df <- data.frame(
  Country = country_names,
  PValue = p_values_kruskal_country
)

print(p_values_kruskal_country_df)

```

###### City-level p-values

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create a vector of city names
city_names <- c("Rio de Janeiro","Sao Paolo","Sinop",
                "Hyderabad","Latur","Visakhapatnam",
                "Birmingham","Edinburgh","London")

# Create a vector of the result object names
kruskal_city_result_names <- c("result_rio","result_saopaulo","result_sinop",
                               "result_hyderabad","result_latur",
                               "result_visakhapatnam","result_birmingham",
                               "result_edinburgh","result_london")

# Retrieve results and store in a list
kruskal_city_result_list <- mget(kruskal_city_result_names)

# Print list to confirm
print(kruskal_city_result_list)

# Extract p-values from the results
p_values_kruskal_city <- sapply(kruskal_city_result_list, function(res) res$p.value)

# Create a dataframe
p_values_kruskal_city_df <- data.frame(
  City = city_names,
  PValue = p_values_kruskal_city
)

print(p_values_kruskal_city_df)


```


#### Chi-squared test

##### Overall results (variation between countries)
```{r echo = FALSE, message = FALSE, warning = FALSE}
# Prepare a contingency table
contingency_table <- data_clean %>%
  group_by(country, org_vendor) %>%
  tally() %>%
  pivot_wider(names_from = org_vendor, values_from = n, values_fill = list(n = 0))

# Convert to matrix 
data_matrix <- as.matrix(contingency_table[, -1])

# Set row names
rownames(data_matrix) <- contingency_table$country

# Display the matrix to check if it's correct
print(data_matrix)

# Perform Chi-squared test
chi_result_overall <- chisq.test(data_matrix)

# Display the results
print(chi_result_overall)

```

##### Country-level results (variation between cities within a given country)

###### Brazil

```{r echo = FALSE, message = FALSE, warning = FALSE}
# Prepare a contingency table
contingency_table <- brazil %>%
  group_by(city, org_vendor) %>%
  tally() %>%
  pivot_wider(names_from = org_vendor, values_from = n, values_fill = list(n = 0))

# Convert to matrix 
data_matrix <- as.matrix(contingency_table[, -1])

# Set row names
rownames(data_matrix) <- contingency_table$city

# Display the matrix to check if it's correct
print(data_matrix)

# Perform Chi-squared test
chi_result_brazil <- chisq.test(data_matrix)

# Display the results
print(chi_result_brazil)

```

###### India

```{r echo = FALSE, message = FALSE, warning = FALSE}
# Prepare a contingency table
contingency_table <- india %>%
  group_by(city, org_vendor) %>%
  tally() %>%
  pivot_wider(names_from = org_vendor, values_from = n, values_fill = list(n = 0))

# Convert to matrix 
data_matrix <- as.matrix(contingency_table[, -1])

# Set row names
rownames(data_matrix) <- contingency_table$city

# Display the matrix to check if it's correct
print(data_matrix)

# Perform Chi-squared test
chi_result_india <- chisq.test(data_matrix)

# Display the results
print(chi_result_india)
```

###### United Kingdom

```{r echo = FALSE, message = FALSE, warning = FALSE}
# Prepare a contingency table
contingency_table <- uk %>%
  group_by(city, org_vendor) %>%
  tally() %>%
  pivot_wider(names_from = org_vendor, values_from = n, values_fill = list(n = 0))

# Convert to matrix 
data_matrix <- as.matrix(contingency_table[, -1])

# Set row names
rownames(data_matrix) <- contingency_table$city

# Display the matrix to check if it's correct
print(data_matrix)

# Perform Chi-squared test
chi_result_uk <- chisq.test(data_matrix)

# Display the results
print(chi_result_uk)
```

##### Neighbourhood-level results (variation between neighbourhoods within a given city)

###### Brazil: Rio de Janeiro

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Prepare a contingency table
contingency_table <- rio %>%
  group_by(circle, org_vendor) %>%
  tally() %>%
  pivot_wider(names_from = org_vendor, values_from = n, values_fill = list(n = 0))

# Convert to matrix 
data_matrix <- as.matrix(contingency_table[, -1])

# Set row names
rownames(data_matrix) <- contingency_table$circle

# Display the matrix to check if it's correct
print(data_matrix)

# Perform Chi-squared test
chi_result_rio <- chisq.test(data_matrix)

# Display the results
print(chi_result_rio)

```


###### Brazil: Sao Paulo

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Prepare a contingency table
contingency_table <- saopaulo %>%
  group_by(circle, org_vendor) %>%
  tally() %>%
  pivot_wider(names_from = org_vendor, values_from = n, values_fill = list(n = 0))

# Convert to matrix 
data_matrix <- as.matrix(contingency_table[, -1])

# Set row names
rownames(data_matrix) <- contingency_table$circle

# Display the matrix to check if it's correct
print(data_matrix)

# Perform Chi-squared test
chi_result_saopaulo <- chisq.test(data_matrix)

# Display the results
print(chi_result_saopaulo)

```

###### Brazil: Sinop

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Prepare a contingency table
contingency_table <- sinop %>%
  group_by(circle, org_vendor) %>%
  tally() %>%
  pivot_wider(names_from = org_vendor, values_from = n, values_fill = list(n = 0))

# Convert to matrix 
data_matrix <- as.matrix(contingency_table[, -1])

# Set row names
rownames(data_matrix) <- contingency_table$circle

# Display the matrix to check if it's correct
print(data_matrix)

# Perform Chi-squared test
chi_result_sinop <- chisq.test(data_matrix)

# Display the results
print(chi_result_sinop)

```

###### India: Hyderabad

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Prepare a contingency table
contingency_table <- hyderabad %>%
  group_by(circle, org_vendor) %>%
  tally() %>%
  pivot_wider(names_from = org_vendor, values_from = n, values_fill = list(n = 0))

# Convert to matrix 
data_matrix <- as.matrix(contingency_table[, -1])

# Set row names
rownames(data_matrix) <- contingency_table$circle

# Display the matrix to check if it's correct
print(data_matrix)

# Perform Chi-squared test
chi_result_hyderabad <- chisq.test(data_matrix)

# Display the results
print(chi_result_hyderabad)

```

###### India: Latur

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Prepare a contingency table
contingency_table <- latur %>%
  group_by(circle, org_vendor) %>%
  tally() %>%
  pivot_wider(names_from = org_vendor, values_from = n, values_fill = list(n = 0))

# Convert to matrix 
data_matrix <- as.matrix(contingency_table[, -1])

# Set row names
rownames(data_matrix) <- contingency_table$circle

# Display the matrix to check if it's correct
print(data_matrix)

# Perform Chi-squared test
chi_result_latur <- chisq.test(data_matrix)

# Display the results
print(chi_result_latur)

```

###### India: Visakhapatnam

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Prepare a contingency table
contingency_table <- visakhapatnam %>%
  group_by(circle, org_vendor) %>%
  tally() %>%
  pivot_wider(names_from = org_vendor, values_from = n, values_fill = list(n = 0))

# Convert to matrix 
data_matrix <- as.matrix(contingency_table[, -1])

# Set row names
rownames(data_matrix) <- contingency_table$circle

# Display the matrix to check if it's correct
print(data_matrix)

# Perform Chi-squared test
chi_result_visakhapatnam <- chisq.test(data_matrix)

# Display the results
print(chi_result_visakhapatnam)
```

###### United Kingdom: Birmingham

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Prepare a contingency table
contingency_table <- birmingham %>%
  group_by(circle, org_vendor) %>%
  tally() %>%
  pivot_wider(names_from = org_vendor, values_from = n, values_fill = list(n = 0))

# Convert to matrix 
data_matrix <- as.matrix(contingency_table[, -1])

# Set row names
rownames(data_matrix) <- contingency_table$circle

# Display the matrix to check if it's correct
print(data_matrix)

# Perform Chi-squared test
chi_result_birmingham <- chisq.test(data_matrix)

# Display the results
print(chi_result_birmingham)

```

###### United Kingdom: Edinburgh

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Prepare a contingency table
contingency_table <- edinburgh %>%
  group_by(circle, org_vendor) %>%
  tally() %>%
  pivot_wider(names_from = org_vendor, values_from = n, values_fill = list(n = 0))

# Convert to matrix 
data_matrix <- as.matrix(contingency_table[, -1])

# Set row names
rownames(data_matrix) <- contingency_table$circle

# Display the matrix to check if it's correct
print(data_matrix)

# Perform Chi-squared test
chi_result_edinburgh <- chisq.test(data_matrix)

# Display the results
print(chi_result_edinburgh)

```

###### United Kingdom: London

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Prepare a contingency table
contingency_table <- london %>%
  group_by(circle, org_vendor) %>%
  tally() %>%
  pivot_wider(names_from = org_vendor, values_from = n, values_fill = list(n = 0))

# Convert to matrix 
data_matrix <- as.matrix(contingency_table[, -1])

# Set row names
rownames(data_matrix) <- contingency_table$circle

# Display the matrix to check if it's correct
print(data_matrix)

# Perform Chi-squared test
chi_result_london <- chisq.test(data_matrix)

# Display the results
print(chi_result_london)

```

##### Summary of p-values

###### Overall p-value

```{r echo = FALSE, message = FALSE, warning = FALSE}

p_values_chi_overall <- chi_result_overall$p.value

print(p_values_chi_overall)
```


###### Country-level p-values
```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create a vector of country names
country_names <- c("Brazil","India","UK")

# Create a vector of the result object names
chi_country_result_names <- c("chi_result_brazil", "chi_result_india", "chi_result_uk")

# Retrieve results and store in a list
chi_country_result_list <- mget(chi_country_result_names)

# Print list to confirm
print(chi_country_result_list)

# Extract p-values from the results
p_values_chi_country <- sapply(chi_country_result_list, function(res) res$p.value)

# Create a dataframe
p_values_chi_country_df <- data.frame(
  Country = country_names,
  PValue = p_values_chi_country
)

print(p_values_chi_country_df)

```


###### City-level p-values

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create a vector of city names
city_names <- c("Rio de Janeiro","Sao Paolo","Sinop",
                "Hyderabad","Latur","Visakhapatnam",
                "Birmingham","Edinburgh","London")

# Create a vector of the result object names
chi_city_result_names <- c("chi_result_rio","chi_result_saopaulo",
                          "chi_result_sinop","chi_result_hyderabad",
                          "chi_result_latur","chi_result_visakhapatnam",
                          "chi_result_birmingham", "chi_result_edinburgh",
                          "chi_result_london")

# Retrieve results and store in a list
chi_city_result_list <- mget(chi_city_result_names)

# Print list to confirm
print(chi_city_result_list)

# Extract p-values from the results
p_values_chi_city <- sapply(chi_city_result_list, function(res) res$p.value)

# Create a dataframe
p_values_chi_city_df <- data.frame(
  City = city_names,
  PValue = p_values_chi_city
)

print(p_values_chi_city_df)


```


#### Summary statistics

##### For each neighbourhood within each city
```{r echo = FALSE, message = FALSE, warning = FALSE}

# Define order of neighbourhood variable
circle_order <- c("Higher","Middle","Lower")
  
# Convert the circle column to a factor with the specified levels
data_clean <- data_clean %>%
  mutate(circle = factor(circle, levels = circle_order))

# Median and IQR number of organic sentinel foods
tab2_median_iqr <- data_clean %>%
  group_by(country, city, circle) %>%
  summarise(
    median_org_foods_count = median(org_foods_count, na.rm = TRUE),
    iqr_org_foods_count = IQR(org_foods_count, na.rm = TRUE)
  ) %>%
  ungroup()

# Count and proportion of vendors with at least one organic sentinal food

  # Count total vendors and organic vendors per neighbourhood
  tab2_count_org <- data_clean %>%
    group_by(country, city, circle) %>%
    summarise(
      vendors = n(),
      count_org_vendors = sum(org_vendor == 1, na.rm = TRUE)
    ) %>%
    ungroup() %>%
    mutate(org_vendor_perc = count_org_vendors / vendors)

# Merge both datasets
tab2_neighbourhood_data <- tab2_median_iqr %>%
  left_join(tab2_count_org, by = c("country", "city", "circle")) %>%
  select(country,city,circle,vendors,count_org_vendors,org_vendor_perc,
         median_org_foods_count,iqr_org_foods_count)


# Create the gt table
tab2_neighbourhood <- tab2_neighbourhood_data %>%
  gt(rowname_col = "circle", groupname_col = c("country","city")) %>%
  cols_label(
    country = "Country",
    city = "City",
    circle = "Neighbourhood",
    vendors = "Total vendors",
    count_org_vendors = "Organic vendors, n(%)",
    org_vendor_perc = " ",
    median_org_foods_count = "Organic sentinel foods, median (IQR)",
    iqr_org_foods_count = " "
  ) %>%
  fmt_percent(
    columns = vars(org_vendor_perc),
    decimals = 0
  ) %>%
  cols_merge(
    columns = c("count_org_vendors", "org_vendor_perc"),
    pattern = "{1} ({2})"
  ) %>%
  cols_merge(
    columns = c("median_org_foods_count", "iqr_org_foods_count"),
    pattern = "{1} ({2})"
  ) %>%
  summary_rows(
    groups = everything(),
    columns = vars(vendors, count_org_vendors, org_vendor_perc,
                   median_org_foods_count, iqr_org_foods_count),
    fns = list(total = ~sum(., na.rm = TRUE)),
    formatter = fmt_number,
    decimals = 0
  ) %>%
  sub_missing() 
  
# Display the table
tab2_neighbourhood

# Note: I can't seem to get it to also have the percentage columns
# Note: Also don't know how to do a grand total - keep getting errors

# Export to table_outputs workbook

addWorksheet(table_outputs, "Table 2")
writeData(table_outputs, sheet = "Table 2", x = tab2)
saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)



```

##### For each city within each country
```{r echo = FALSE, message = FALSE, warning = FALSE}
# Median and IQR for each city within each country
tab2_city_median_iqr <- data_clean %>%
  group_by(country, city) %>%
  summarize(
    median_org_foods_count = median(org_foods_count, na.rm = TRUE),
    iqr_org_foods_count = IQR(org_foods_count, na.rm = TRUE)
  ) %>%
  ungroup()

# Count and proportion of vendors with at least one organic sentinal food

  # Count total vendors and organic vendors per city
  tab2_city_count_org <- data_clean %>%
    group_by(country, city) %>%
    summarise(
      vendors = n(),
      count_org_vendors = sum(org_vendor == 1, na.rm = TRUE)
    ) %>%
    ungroup() %>%
    mutate(org_vendor_perc = count_org_vendors / vendors)

# Merge both datasets
tab2_city_data <- tab2_city_median_iqr %>%
  left_join(tab2_city_count_org, by = c("country", "city")) %>%
  select(country,city,vendors,count_org_vendors,org_vendor_perc,
         median_org_foods_count,iqr_org_foods_count)




```

##### For each country
```{r echo = FALSE, message = FALSE, warning = FALSE}
# Median and IQR for each country
country_stats <- data_clean %>%
  group_by(country) %>%
  summarize(
    median_org_foods_count = median(org_foods_count, na.rm = TRUE),
    iqr_org_foods_count = IQR(org_foods_count, na.rm = TRUE)
  ) %>%
  ungroup()

print(country_stats)
```

##### Overall
```{r echo = FALSE, message = FALSE, warning = FALSE}
# Calculate the overall median and IQR
overall_median <- median(data_clean$org_foods_count, na.rm = TRUE)
overall_iqr <- IQR(data_clean$org_foods_count, na.rm = TRUE)

# Display the results
overall_median
overall_iqr
```


### Exploratory Analysis: Hypothesis 1b. The count and proportion of vendors selling multiple organic options for at least one sentinel food will be highest in the United Kingdom, in larger cities within a given country, and in higher-income neighbourhoods within a given city.


#### Median and interquartile range

##### For each neighbourhood within each city
```{r echo = FALSE, message = FALSE, warning = FALSE}
# Median and IQR for each neighborhood within each city
neighborhood_stats2 <- data_clean %>%
  group_by(country, city, circle) %>%
  summarize(
    median_multiple_org_count = median(multiple_org_count, na.rm = TRUE),
    iqr_multiple_org_count = IQR(multiple_org_count, na.rm = TRUE)
  ) %>%
  ungroup()

print(neighborhood_stats2)
```

##### For each city within each country
```{r echo = FALSE, message = FALSE, warning = FALSE}
# Median and IQR for each city within each country
city_stats2 <- data_clean %>%
  group_by(country, city) %>%
  summarize(
    median_multiple_org_count = median(multiple_org_count, na.rm = TRUE),
    iqr_multiple_org_count = IQR(multiple_org_count, na.rm = TRUE)
  ) %>%
  ungroup()

print(city_stats2)
```

##### For each country
```{r echo = FALSE, message = FALSE, warning = FALSE}
# Median and IQR for each country
country_stats2 <- data_clean %>%
  group_by(country) %>%
  summarize(
    median_multiple_org_count = median(multiple_org_count, na.rm = TRUE),
    iqr_multiple_org_count = IQR(multiple_org_count, na.rm = TRUE)
  ) %>%
  ungroup()

print(country_stats2)
```

##### Overall
```{r echo = FALSE, message = FALSE, warning = FALSE}
# Calculate the overall median and IQR
overall_median2 <- median(data_clean$multiple_org_count, na.rm = TRUE)
overall_iqr2 <- IQR(data_clean$multiple_org_count, na.rm = TRUE)

# Display the results
overall_median2
overall_iqr2
```

### Exploratory Analysis: Organic versus non-organic vendor characteristics

#### Country-level

```{r echo = FALSE, message = FALSE, warning = FALSE}
# Summarize the data grouped by `org_vendor` and `country`
country_summary_stats <- data_clean %>%
  group_by(country, org_vendor) %>%
  summarize(
    median_vendor_cashiers = median(vendor_cashiers, na.rm = TRUE),
    iqr_vendor_cashiers = IQR(vendor_cashiers, na.rm = TRUE),
    min_vendor_cashiers = min(vendor_cashiers, na.rm = TRUE),
    max_vendor_cashiers = max(vendor_cashiers, na.rm = TRUE),
    
    median_days_open_count = median(days_open_count, na.rm = TRUE),
    iqr_days_open_count = IQR(days_open_count, na.rm = TRUE),
    min_days_open_count = min(days_open_count, na.rm = TRUE),
    max_days_open_count = max(days_open_count, na.rm = TRUE),
    
    median_foods_count = median(foods_count, na.rm = TRUE),
    iqr_foods_count = IQR(foods_count, na.rm = TRUE),
    min_foods_count = min(foods_count, na.rm = TRUE),
    max_foods_count = max(foods_count, na.rm = TRUE)
  ) %>%
  ungroup()

# Display the country-level results
print(country_summary_stats)
```

#### Overall

```{r echo = FALSE, message = FALSE, warning = FALSE}
# Summarize the data for overall statistics grouped by `org_vendor`
overall_summary_stats <- data_clean %>%
  group_by(org_vendor) %>%
  summarize(
    median_vendor_cashiers = median(vendor_cashiers, na.rm = TRUE),
    iqr_vendor_cashiers = IQR(vendor_cashiers, na.rm = TRUE),
    min_vendor_cashiers = min(vendor_cashiers, na.rm = TRUE),
    max_vendor_cashiers = max(vendor_cashiers, na.rm = TRUE),
    
    median_days_open_count = median(days_open_count, na.rm = TRUE),
    iqr_days_open_count = IQR(days_open_count, na.rm = TRUE),
    min_days_open_count = min(days_open_count, na.rm = TRUE),
    max_days_open_count = max(days_open_count, na.rm = TRUE),
    
    median_foods_count = median(foods_count, na.rm = TRUE),
    iqr_foods_count = IQR(foods_count, na.rm = TRUE),
    min_foods_count = min(foods_count, na.rm = TRUE),
    max_foods_count = max(foods_count, na.rm = TRUE)
  ) %>%
  ungroup()

# Display the overall results
print(overall_summary_stats)
```


## 2. How affordable is a sentinel organic food (rice) compared to a non-organic sentinel food (rice) in urban food environments? How does this vary across different geographic contexts?

### Hypothesis 2a. The price of organic rice will be significantly higher than the price of non-organic rice overall and at the country level.


```{r include=FALSE}

# Load cleaned rice prices data
rice_prices_data <- read.xlsx("C:/Users/s1985751/Documents/GitHub/fea/rice_prices_data_clean.xlsx", sheet = "data")

```

#### Mann-Whitney U test

##### Overall results
```{r echo = FALSE, message = FALSE, warning = FALSE}


# Create data frame of country and rice_price_org_kg_usd
mw_rice_prices_data <- rice_prices_data %>%
  select(country, rice_price_org_kg_usd, rice_price_conv_kg_usd)

# Overall Mann-Whitney U test
overall_test <- wilcox.test(rice_price_org_kg_usd, rice_price_conv_kg_usd, 
                            alternative = "greater", paired = "false")

print(test_result)

overall_p_value_one_tailed <- overall_test$p.value / 2



# Create data frame of country and rice_price_org_kg_usd
mw_rice_prices_data <- rice_prices_data %>%
  select(country, rice_price_org_kg_usd, rice_price_conv_kg_usd)

# Reshape data to long form
reshaped_data <- mw_rice_prices_data %>%
  pivot_longer(cols = c(rice_price_org_kg_usd, rice_price_conv_kg_usd), 
               names_to = "type", 
               values_to = "price") %>%
  mutate(type = ifelse(type == "rice_price_org_kg_usd", "organic", "conventional")) %>%
  filter(!is.na(price))

# Overall Mann-Whitney U test
overall_test <- wilcox.test(price ~ type, data = reshaped_data, 
                            alternative = "greater")
overall_p_value_one_tailed <- overall_test$p.value / 2

# Print overall test results
cat("Overall Mann-Whitney test p-value (one-tailed):", overall_p_value_one_tailed, "\n")


```

##### Overall results
```{r echo = FALSE, message = FALSE, warning = FALSE}

# Function to perform Kruskal-Wallis test for each country
country_tests <- reshaped_data %>%
  group_by(country) %>%
  do(test = kruskal.test(price ~ type, data = .)) %>%
  mutate(p_value_one_tailed = test$p.value / 2)

# Print country-level test results
country_tests %>%
  rowwise() %>%
  mutate(
    country = country,
    p_value_one_tailed = test$p.value / 2
  ) %>%
  select(country, p_value_one_tailed) %>%
  print()

```

#### Table 5: City-level summary statistics

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Calculate number of organic and conventional vendors, median, IQR, min and max price
tab5_summary_stats <- rice_prices_data %>%
  group_by(country, city) %>%
  summarise(
    count_org_rice_vendors = sum(!is.na(rice_price_org_kg_usd)),
    count_conv_rice_vendors = sum(!is.na(rice_price_conv_kg_usd)),
    median_org_rice = median(rice_price_org_kg_usd, na.rm = TRUE),
    iqr_org_rice = IQR(rice_price_org_kg_usd, na.rm = TRUE),
    min_org_rice = min(rice_price_org_kg_usd, na.rm = TRUE),
    max_org_rice = max(rice_price_org_kg_usd, na.rm = TRUE),
    median_conv_rice = median(rice_price_conv_kg_usd, na.rm = TRUE),
    iqr_conv_rice = IQR(rice_price_conv_kg_usd, na.rm = TRUE),
    min_conv_rice = min(rice_price_conv_kg_usd, na.rm = TRUE),
    max_conv_rice = max(rice_price_conv_kg_usd, na.rm = TRUE),
  ) %>%
  ungroup()

# Create the gt table
tab5 <- tab5_summary_stats %>%
  gt(rowname_col = "city", groupname_col = c("country")) %>%
  cols_label(
    country = "Country",
    city = "City",
    count_org_rice_vendors = "Organic sample size (n)",
    count_conv_rice_vendors = "Conventional sample size (n)",
    median_org_rice = "Organic median (IQR), min-max (US$)",
    iqr_org_rice = " ",
    min_org_rice = " ",
    max_org_rice = " ",
    median_conv_rice = "Conventional median (IQR), min-max (US$)",
    iqr_conv_rice = " ",
    min_conv_rice = " ",
    max_conv_rice = " "
  ) %>%
  cols_merge(
    columns = c("median_org_rice", "iqr_org_rice", "min_org_rice", "max_org_rice"),
    pattern = "{1} ({2}), {3}-{4}"
  ) %>%
    cols_merge(
    columns = c("median_conv_rice", "iqr_conv_rice", "min_conv_rice", "max_conv_rice"),
    pattern = "{1} ({2}), {3}-{4}"
  ) %>%
  fmt_number(
    columns = vars(median_org_rice, iqr_org_rice, min_org_rice, max_org_rice,
                   median_conv_rice, iqr_conv_rice, min_conv_rice, max_conv_rice),
    decimals = 2
  ) %>%
  summary_rows(
    groups = everything(),
    columns = vars(count_org_rice_vendors,count_conv_rice_vendors),
    fns = list(total = ~sum(., na.rm = TRUE)),
    formatter = fmt_number,
    decimals = 0,
  ) %>%
  sub_missing() 
  
# Display the table
tab5

```

#### Table 5: Country-level summary statistics


```{r echo = FALSE, message = FALSE, warning = FALSE}

# Calculate number of organic and conventional vendors, median, IQR, min and max price
tab5_country_summary_stats <- rice_prices_data %>%
  group_by(country) %>%
  summarise(
    count_org_rice_vendors = sum(!is.na(rice_price_org_kg_usd)),
    count_conv_rice_vendors = sum(!is.na(rice_price_conv_kg_usd)),
    median_org_rice = median(rice_price_org_kg_usd, na.rm = TRUE),
    iqr_org_rice = IQR(rice_price_org_kg_usd, na.rm = TRUE),
    min_org_rice = min(rice_price_org_kg_usd, na.rm = TRUE),
    max_org_rice = max(rice_price_org_kg_usd, na.rm = TRUE),
    median_conv_rice = median(rice_price_conv_kg_usd, na.rm = TRUE),
    iqr_conv_rice = IQR(rice_price_conv_kg_usd, na.rm = TRUE),
    min_conv_rice = min(rice_price_conv_kg_usd, na.rm = TRUE),
    max_conv_rice = max(rice_price_conv_kg_usd, na.rm = TRUE),
  ) %>%
  ungroup()

print(tab5_country_summary_stats)

```

