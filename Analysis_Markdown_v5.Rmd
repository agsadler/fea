---
title: "Organic Food Environment Assessment"
author: "Alexandra Sadler"
date: "19/07/2024"
output: word_document
---

```{r setup, include=FALSE}
# Load necessary libraries
library(dplyr)
library(ggplot2)
library(gmodels)
library(gt)
library(knitr)
library(kableExtra)
library(openxlsx)
library(readxl)
library(readr)
library(stats)
library(tidyr)
library(tidyverse)

knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}

# Set working directory
#setwd("C:/Users/s1985751/Documents/GitHub/fea")


# Load cleaned data
data_clean <- read.xlsx("data_clean.xlsx", sheet = "data")

# Create workbook for table data
table_outputs <- createWorkbook()
saveWorkbook(table_outputs, "Outputs/table_outputs.xlsx", overwrite = TRUE)


```

## Descriptive Results

### Table 1

```{r echo = FALSE, message = FALSE, warning = FALSE}
# Generate Table 1

# Calculate total vendors per city
tab1_total_vendors <- data_clean %>%
  group_by(country, city) %>%
  summarise(total_vendors = n()) %>%
  ungroup()

# Calculate neighbourhood counts and percentages
tab1_neighbourhood_data <- data_clean %>%
  group_by(country, city, circle) %>%
  summarise(count = n()) %>%
  pivot_wider(names_from = circle, values_from = count, values_fill = list(count = 0)) %>%
  ungroup() %>%
  left_join(tab1_total_vendors, by = c("country", "city")) %>%
  mutate(
    higher_perc = round((Higher / total_vendors)*100,2),
    middle_perc = round((Middle / total_vendors)*100,2),
    lower_perc = round((Lower / total_vendors)*100,2)
  ) %>%
  select(country, city, total_vendors, Higher, higher_perc, Middle, middle_perc, Lower, lower_perc)

# Calculate store type counts and percentages
tab1_store_data <- data_clean %>%
  group_by(country, city, vendor_type) %>%
  summarise(count = n()) %>%
  pivot_wider(names_from = vendor_type, values_from = count, values_fill = list(count = 0)) %>%
  ungroup() %>%
  left_join(tab1_total_vendors, by = c("country", "city")) %>%
  mutate(
    supermarket_perc = round((Supermarket / total_vendors)*100,2),
    mobile_vendor_perc = round((`Mobile vendor` / total_vendors)*100,2),
    stationary_small_vendor_perc = round((`Stationary small local vendor` / total_vendors)*100,2)
  ) %>%
  select(country, city, `Mobile vendor`, mobile_vendor_perc, `Stationary small local vendor`, stationary_small_vendor_perc, Supermarket, supermarket_perc,  )


# Merge both datasets
tab1_data <- tab1_neighbourhood_data %>%
  left_join(tab1_store_data, by = c("country", "city"))

# Calculate country-level totals
tab1_country_totals <- tab1_data %>%
  group_by(country) %>%
  summarise(
    total_vendors = sum(total_vendors, na.rm = TRUE),
    Higher = sum(Higher, na.rm = TRUE),
    Middle = sum(Middle, na.rm = TRUE),
    Lower = sum(Lower, na.rm = TRUE),
    `Mobile vendor` = sum(`Mobile vendor`, na.rm = TRUE),
    `Stationary small local vendor` = sum(`Stationary small local vendor`, na.rm = TRUE),
    Supermarket = sum(Supermarket, na.rm = TRUE)
  ) %>%
  mutate(
    higher_perc = round((Higher / total_vendors)*100, 2),
    middle_perc = round((Middle / total_vendors)*100, 2),
    lower_perc = round((Lower / total_vendors)*100, 2),
    mobile_vendor_perc = round((`Mobile vendor` / total_vendors)*100,2),
    stationary_small_vendor_perc = round((`Stationary small local vendor` / total_vendors)*100,2),
    supermarket_perc = round((Supermarket / total_vendors)*100,2),
    city = "Total"  # Mark these as totals per country
  )

# Calculate overall totals across all countries
tab1_overall_totals <- tab1_data %>%
  summarise(
    country = "Overall",
    total_vendors = sum(total_vendors, na.rm = TRUE),
    Higher = sum(Higher, na.rm = TRUE),
    Middle = sum(Middle, na.rm = TRUE),
    Lower = sum(Lower, na.rm = TRUE),
    `Mobile vendor` = sum(`Mobile vendor`, na.rm = TRUE),
    `Stationary small local vendor` = sum(`Stationary small local vendor`, na.rm = TRUE),
    Supermarket = sum(Supermarket, na.rm = TRUE)
  ) %>%
  mutate(
    higher_perc = round((Higher / total_vendors)*100,2),
    middle_perc = round((Middle / total_vendors)*100,2),
    lower_perc = round((Lower / total_vendors)*100,2),
    mobile_vendor_perc = round((`Mobile vendor` / total_vendors)*100,2),
    stationary_small_vendor_perc = round((`Stationary small local vendor` / total_vendors)*100,2),
    supermarket_perc = round((Supermarket / total_vendors)*100,2),
    city = "Overall"
  )

# Append country-level totals and overall totals to the main data and clean up columns
tab1_data_final <- tab1_data %>%
  bind_rows(tab1_country_totals) %>%
  bind_rows(tab1_overall_totals) %>%
  mutate(
    neighbourhood_higher = paste0(Higher, " (", higher_perc, "%)"),
    neighbourhood_middle = paste0(Middle, " (", middle_perc, "%)"),
    neighbourhood_lower = paste0(Lower, " (", lower_perc, "%)"),
    storetype_mob = paste0(`Mobile vendor`, " (", mobile_vendor_perc, "%)"),
    storetype_stat = paste0(`Stationary small local vendor`, " (", stationary_small_vendor_perc, "%)"),
    storetype_super = paste0(Supermarket, " (", supermarket_perc, "%)")
  ) %>%
  select(country, city, total_vendors, 
         neighbourhood_higher, neighbourhood_middle, neighbourhood_lower,
         storetype_mob, storetype_stat, storetype_super)

# Display the table
tab1_data_final


# Export to table_outputs workbook

addWorksheet(table_outputs, "Table 1")
writeData(table_outputs, sheet = "Table 1", x = tab1_data_final)
saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)


```



## 1. What is the availability of organic food in urban food environments? How does this vary across different geographic and socioeconomic contexts?

### Hypothesis 1a. Organic food availability will be highest in the United Kingdom, in larger cities within a given country, and in higher-income neighbourhoods within a given city.

#### Kruskal-Wallis rank sum test

##### Overall results (variation between countries)
```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame of country and org_products_count
kruskal_country_data <- data_clean %>%
  select(country, org_products_count)

# Perform the Kruskal-Wallis test
result_overall <- kruskal.test(org_products_count ~ country, data = kruskal_country_data)
  
# Display the results
print(result_overall)

```

##### Country-level results (variation between cities within a given country)

###### Brazil

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame for Brazil
brazil <- data_clean %>%
  filter(country == "Brazil")

# Create data frame of city and org_products_count
kruskal_brazil_city_data <- brazil %>%
  select(city, org_products_count)

# Perform the Kruskal-Wallis test
result_brazil <- kruskal.test(org_products_count ~ city, data = kruskal_brazil_city_data)
  
# Display the results
print(result_brazil)

```

###### India

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame for India
india <- data_clean %>%
  filter(country == "India")

# Create data frame of city and org_products_count
kruskal_india_city_data <- india %>%
  select(city, org_products_count)

# Perform the Kruskal-Wallis test
result_india <- kruskal.test(org_products_count ~ city, data = kruskal_india_city_data)
  
# Display the results
print(result_india)

```

###### United Kingdom

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame for India
uk <- data_clean %>%
  filter(country == "UK")

# Create data frame of city and org_products_count
kruskal_uk_city_data <- uk %>%
  select(city, org_products_count)

# Perform the Kruskal-Wallis test
result_uk <- kruskal.test(org_products_count ~ city, data = kruskal_uk_city_data)
  
# Display the results
print(result_uk)

```

##### City-level results (variation between neighbourhoods within a given city)

###### Brazil: Rio de Janeiro

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame for Rio de Janeiro
rio <- data_clean %>%
  filter(city == "Rio de Janeiro")

# Create data frame of circle and org_products_count
kruskal_rio_data <- rio %>%
  select(circle, org_products_count)

# Perform the Kruskal-Wallis test
result_rio <- kruskal.test(org_products_count ~ circle, data = kruskal_rio_data)
  
# Display the results
print(result_rio)

```

###### Brazil: Sao Paulo

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame for Sao Paulo
saopaulo <- data_clean %>%
  filter(city == "Sao Paolo")

# Create data frame of circle and org_products_count
kruskal_saopaulo_data <- saopaulo %>%
  select(circle, org_products_count)

# Perform the Kruskal-Wallis test
result_saopaulo <- kruskal.test(org_products_count ~ circle, data = kruskal_saopaulo_data)
  
# Display the results
print(result_saopaulo)

```

###### Brazil: Sinop

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame for Sinop
sinop <- data_clean %>%
  filter(city == "Sinop")

# Create data frame of circle and org_products_count
kruskal_sinop_data <- sinop %>%
  select(circle, org_products_count)

# Perform the Kruskal-Wallis test
result_sinop <- kruskal.test(org_products_count ~ circle, data = kruskal_sinop_data)
  
# Display the results
print(result_sinop)

```


###### India: Hyderabad

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame for Hyderabad
hyderabad <- data_clean %>%
  filter(city == "Hyderabad")

# Create data frame of circle and org_products_count
kruskal_hyderabad_data <- hyderabad %>%
  select(circle, org_products_count)

# Perform the Kruskal-Wallis test
result_hyderabad <- kruskal.test(org_products_count ~ circle, data = kruskal_hyderabad_data)
  
# Display the results
print(result_hyderabad)

```

###### India: Latur

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame for Latur
latur <- data_clean %>%
  filter(city == "Latur")

# Create data frame of circle and org_products_count
kruskal_latur_data <- latur %>%
  select(circle, org_products_count)

# Perform the Kruskal-Wallis test
result_latur <- kruskal.test(org_products_count ~ circle, data = kruskal_latur_data)
  
# Display the results
print(result_latur)

```

###### India: Visakhapatnam

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame for Visakhapatnam
visakhapatnam <- data_clean %>%
  filter(city == "Visakhapatnam")

# Create data frame of circle and org_products_count
kruskal_visakhapatnam_data <- visakhapatnam %>%
  select(circle, org_products_count)

# Perform the Kruskal-Wallis test
result_visakhapatnam <- kruskal.test(org_products_count ~ circle, data = kruskal_visakhapatnam_data)
  
# Display the results
print(result_visakhapatnam)

```

###### United Kingdom: Birmingham

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame for Birmingham
birmingham <- data_clean %>%
  filter(city == "Birmingham")

# Create data frame of circle and org_products_count
kruskal_birmingham_data <- birmingham %>%
  select(circle, org_products_count)

# Perform the Kruskal-Wallis test
result_birmingham <- kruskal.test(org_products_count ~ circle, data = kruskal_birmingham_data)
  
# Display the results
print(result_birmingham)

```

###### UK: Edinburgh

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame for Edinburgh
edinburgh <- data_clean %>%
  filter(city == "Edinburgh")

# Create data frame of circle and org_products_count
kruskal_edinburgh_data <- edinburgh %>%
  select(circle, org_products_count)

# Perform the Kruskal-Wallis test
result_edinburgh <- kruskal.test(org_products_count ~ circle, data = kruskal_edinburgh_data)
  
# Display the results
print(result_edinburgh)

```

###### UK: London

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame for London
london <- data_clean %>%
  filter(city == "London")

# Create data frame of circle and org_products_count
kruskal_london_data <- london %>%
  select(circle, org_products_count)

# Perform the Kruskal-Wallis test
result_london <- kruskal.test(org_products_count ~ circle, data = kruskal_london_data)
  
# Display the results
print(result_london)

```

##### Summary of p-values

###### Overall p-value

```{r echo = FALSE, message = FALSE, warning = FALSE}

p_values_kruskal_overall <- result_overall$p.value

print(p_values_kruskal_overall)
```


###### Country-level p-values
```{r echo = FALSE, message = FALSE, warning = FALSE, results = 'hide'}

# Create a vector of country names
country_names <- c("Brazil","India","UK")

# Create a vector of the result object names
kruskal_country_result_names <- c("result_brazil", "result_india", "result_uk")

# Retrieve results and store in a list
kruskal_country_result_list <- mget(kruskal_country_result_names)

# Print list to confirm
print(kruskal_country_result_list)

# Extract p-values from the results
p_values_kruskal_country <- sapply(kruskal_country_result_list, function(res) res$p.value)

# Create a dataframe
p_values_kruskal_country_df <- data.frame(
  Country = country_names,
  PValue = p_values_kruskal_country
)

print(p_values_kruskal_country_df)

```

###### City-level p-values

```{r echo = FALSE, message = FALSE, warning = FALSE, results = 'hide'}

# Create a vector of city names
city_names <- c("Rio de Janeiro","Sao Paolo","Sinop",
                "Hyderabad","Latur","Visakhapatnam",
                "Birmingham","Edinburgh","London")

# Create a vector of the result object names
kruskal_city_result_names <- c("result_rio","result_saopaulo","result_sinop",
                               "result_hyderabad","result_latur",
                               "result_visakhapatnam","result_birmingham",
                               "result_edinburgh","result_london")

# Retrieve results and store in a list
kruskal_city_result_list <- mget(kruskal_city_result_names)

# Print list to confirm
print(kruskal_city_result_list)

# Extract p-values from the results
p_values_kruskal_city <- sapply(kruskal_city_result_list, function(res) res$p.value)

# Create a dataframe
p_values_kruskal_city_df <- data.frame(
  City = city_names,
  PValue = p_values_kruskal_city
)

print(p_values_kruskal_city_df)


```


#### Chi-squared test

##### Overall results (variation between countries)
```{r echo = FALSE, message = FALSE, warning = FALSE}
# Prepare a contingency table
contingency_table <- data_clean %>%
  group_by(country, org_vendor) %>%
  tally() %>%
  pivot_wider(names_from = org_vendor, values_from = n, values_fill = list(n = 0))

# Convert to matrix 
data_matrix <- as.matrix(contingency_table[, -1])

# Set row names
rownames(data_matrix) <- contingency_table$country

# Display the matrix to check if it's correct
print(data_matrix)

# Perform Chi-squared test
chi_result_overall <- chisq.test(data_matrix)

# Display the results
print(chi_result_overall)

```

##### Country-level results (variation between cities within a given country)

###### Brazil

```{r echo = FALSE, message = FALSE, warning = FALSE}
# Prepare a contingency table
contingency_table <- brazil %>%
  group_by(city, org_vendor) %>%
  tally() %>%
  pivot_wider(names_from = org_vendor, values_from = n, values_fill = list(n = 0))

# Convert to matrix 
data_matrix <- as.matrix(contingency_table[, -1])

# Set row names
rownames(data_matrix) <- contingency_table$city

# Display the matrix to check if it's correct
print(data_matrix)

# Perform Chi-squared test
chi_result_brazil <- chisq.test(data_matrix)

# Display the results
print(chi_result_brazil)

```

###### India

```{r echo = FALSE, message = FALSE, warning = FALSE}
# Prepare a contingency table
contingency_table <- india %>%
  group_by(city, org_vendor) %>%
  tally() %>%
  pivot_wider(names_from = org_vendor, values_from = n, values_fill = list(n = 0))

# Convert to matrix 
data_matrix <- as.matrix(contingency_table[, -1])

# Set row names
rownames(data_matrix) <- contingency_table$city

# Display the matrix to check if it's correct
print(data_matrix)

# Perform Chi-squared test
chi_result_india <- chisq.test(data_matrix)

# Display the results
print(chi_result_india)
```

###### United Kingdom

```{r echo = FALSE, message = FALSE, warning = FALSE}
# Prepare a contingency table
contingency_table <- uk %>%
  group_by(city, org_vendor) %>%
  tally() %>%
  pivot_wider(names_from = org_vendor, values_from = n, values_fill = list(n = 0))

# Convert to matrix 
data_matrix <- as.matrix(contingency_table[, -1])

# Set row names
rownames(data_matrix) <- contingency_table$city

# Display the matrix to check if it's correct
print(data_matrix)

# Perform Chi-squared test
chi_result_uk <- chisq.test(data_matrix)

# Display the results
print(chi_result_uk)
```

##### Neighbourhood-level results (variation between neighbourhoods within a given city)

###### Brazil: Rio de Janeiro

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Prepare a contingency table
contingency_table <- rio %>%
  group_by(circle, org_vendor) %>%
  tally() %>%
  pivot_wider(names_from = org_vendor, values_from = n, values_fill = list(n = 0))

# Convert to matrix 
data_matrix <- as.matrix(contingency_table[, -1])

# Set row names
rownames(data_matrix) <- contingency_table$circle

# Display the matrix to check if it's correct
print(data_matrix)

# Perform Chi-squared test
chi_result_rio <- chisq.test(data_matrix)

# Display the results
print(chi_result_rio)

```


###### Brazil: Sao Paulo

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Prepare a contingency table
contingency_table <- saopaulo %>%
  group_by(circle, org_vendor) %>%
  tally() %>%
  pivot_wider(names_from = org_vendor, values_from = n, values_fill = list(n = 0))

# Convert to matrix 
data_matrix <- as.matrix(contingency_table[, -1])

# Set row names
rownames(data_matrix) <- contingency_table$circle

# Display the matrix to check if it's correct
print(data_matrix)

# Perform Chi-squared test
chi_result_saopaulo <- chisq.test(data_matrix)

# Display the results
print(chi_result_saopaulo)

```

###### Brazil: Sinop

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Prepare a contingency table
contingency_table <- sinop %>%
  group_by(circle, org_vendor) %>%
  tally() %>%
  pivot_wider(names_from = org_vendor, values_from = n, values_fill = list(n = 0))

# Convert to matrix 
data_matrix <- as.matrix(contingency_table[, -1])

# Set row names
rownames(data_matrix) <- contingency_table$circle

# Display the matrix to check if it's correct
print(data_matrix)

# Perform Chi-squared test
chi_result_sinop <- chisq.test(data_matrix)

# Display the results
print(chi_result_sinop)

```

###### India: Hyderabad

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Prepare a contingency table
contingency_table <- hyderabad %>%
  group_by(circle, org_vendor) %>%
  tally() %>%
  pivot_wider(names_from = org_vendor, values_from = n, values_fill = list(n = 0))

# Convert to matrix 
data_matrix <- as.matrix(contingency_table[, -1])

# Set row names
rownames(data_matrix) <- contingency_table$circle

# Display the matrix to check if it's correct
print(data_matrix)

# Perform Chi-squared test
chi_result_hyderabad <- chisq.test(data_matrix)

# Display the results
print(chi_result_hyderabad)

```

###### India: Latur

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Prepare a contingency table
contingency_table <- latur %>%
  group_by(circle, org_vendor) %>%
  tally() %>%
  pivot_wider(names_from = org_vendor, values_from = n, values_fill = list(n = 0))

# Convert to matrix 
data_matrix <- as.matrix(contingency_table[, -1])

# Set row names
rownames(data_matrix) <- contingency_table$circle

# Display the matrix to check if it's correct
print(data_matrix)

# Perform Chi-squared test
chi_result_latur <- chisq.test(data_matrix)

# Display the results
print(chi_result_latur)

```

###### India: Visakhapatnam

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Prepare a contingency table
contingency_table <- visakhapatnam %>%
  group_by(circle, org_vendor) %>%
  tally() %>%
  pivot_wider(names_from = org_vendor, values_from = n, values_fill = list(n = 0))

# Convert to matrix 
data_matrix <- as.matrix(contingency_table[, -1])

# Set row names
rownames(data_matrix) <- contingency_table$circle

# Display the matrix to check if it's correct
print(data_matrix)

# Perform Chi-squared test
chi_result_visakhapatnam <- chisq.test(data_matrix)

# Display the results
print(chi_result_visakhapatnam)
```

###### United Kingdom: Birmingham

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Prepare a contingency table
contingency_table <- birmingham %>%
  group_by(circle, org_vendor) %>%
  tally() %>%
  pivot_wider(names_from = org_vendor, values_from = n, values_fill = list(n = 0))

# Convert to matrix 
data_matrix <- as.matrix(contingency_table[, -1])

# Set row names
rownames(data_matrix) <- contingency_table$circle

# Display the matrix to check if it's correct
print(data_matrix)

# Perform Chi-squared test
chi_result_birmingham <- chisq.test(data_matrix)

# Display the results
print(chi_result_birmingham)

```

###### United Kingdom: Edinburgh

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Prepare a contingency table
contingency_table <- edinburgh %>%
  group_by(circle, org_vendor) %>%
  tally() %>%
  pivot_wider(names_from = org_vendor, values_from = n, values_fill = list(n = 0))

# Convert to matrix 
data_matrix <- as.matrix(contingency_table[, -1])

# Set row names
rownames(data_matrix) <- contingency_table$circle

# Display the matrix to check if it's correct
print(data_matrix)

# Perform Chi-squared test
chi_result_edinburgh <- chisq.test(data_matrix)

# Display the results
print(chi_result_edinburgh)

```

###### United Kingdom: London

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Prepare a contingency table
contingency_table <- london %>%
  group_by(circle, org_vendor) %>%
  tally() %>%
  pivot_wider(names_from = org_vendor, values_from = n, values_fill = list(n = 0))

# Convert to matrix 
data_matrix <- as.matrix(contingency_table[, -1])

# Set row names
rownames(data_matrix) <- contingency_table$circle

# Display the matrix to check if it's correct
print(data_matrix)

# Perform Chi-squared test
chi_result_london <- chisq.test(data_matrix)

# Display the results
print(chi_result_london)

```

##### Summary of p-values

###### Overall p-value

```{r echo = FALSE, message = FALSE, warning = FALSE}

p_values_chi_overall <- chi_result_overall$p.value

print(p_values_chi_overall)
```


###### Country-level p-values
```{r echo = FALSE, message = FALSE, warning = FALSE, results = 'hide'}

# Create a vector of country names
country_names <- c("Brazil","India","UK")

# Create a vector of the result object names
chi_country_result_names <- c("chi_result_brazil", "chi_result_india", "chi_result_uk")

# Retrieve results and store in a list
chi_country_result_list <- mget(chi_country_result_names)

# Print list to confirm
print(chi_country_result_list)

# Extract p-values from the results
p_values_chi_country <- sapply(chi_country_result_list, function(res) res$p.value)

# Create a dataframe
p_values_chi_country_df <- data.frame(
  Country = country_names,
  PValue = p_values_chi_country
)

print(p_values_chi_country_df)

```


###### City-level p-values

```{r echo = FALSE, message = FALSE, warning = FALSE, results = 'hide'}

# Create a vector of city names
city_names <- c("Rio de Janeiro","Sao Paolo","Sinop",
                "Hyderabad","Latur","Visakhapatnam",
                "Birmingham","Edinburgh","London")

# Create a vector of the result object names
chi_city_result_names <- c("chi_result_rio","chi_result_saopaulo",
                          "chi_result_sinop","chi_result_hyderabad",
                          "chi_result_latur","chi_result_visakhapatnam",
                          "chi_result_birmingham", "chi_result_edinburgh",
                          "chi_result_london")

# Retrieve results and store in a list
chi_city_result_list <- mget(chi_city_result_names)

# Print list to confirm
print(chi_city_result_list)

# Extract p-values from the results
p_values_chi_city <- sapply(chi_city_result_list, function(res) res$p.value)

# Create a dataframe
p_values_chi_city_df <- data.frame(
  City = city_names,
  PValue = p_values_chi_city
)

print(p_values_chi_city_df)


```


#### Table 2 - Availability

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Define order of neighbourhood variable
circle_order <- c("Higher","Middle","Lower")
  
# Convert the circle column to a factor with the specified levels
tab2_data <- data_clean %>%
  mutate(circle = factor(circle, levels = circle_order))

# Create table of neighbourhood data
tab2_neighbourhood <- tab2_data %>%
  group_by(country, city, circle) %>%
  summarise(
    vendors = n(),
    count_org_vendors = sum(org_vendor == 1, na.rm = TRUE),
    org_vendor_perc = count_org_vendors / vendors,
    median_org_products_count = median(org_products_count, na.rm = TRUE),
    iqr_org_products_count = IQR(org_products_count, na.rm = TRUE)
  ) %>%
  ungroup()

# Create city rows
tab2_city <- tab2_data %>%
  group_by(country, city) %>%
  summarise(
    vendors = n(),
    count_org_vendors = sum(org_vendor == 1, na.rm = TRUE),
    org_vendor_perc = count_org_vendors / vendors,
    median_org_products_count = median(org_products_count, na.rm = TRUE),
    iqr_org_products_count = IQR(org_products_count, na.rm = TRUE)
  ) %>%
  ungroup()

# Create country rows
tab2_country <- tab2_data %>%
  group_by(country) %>%
  summarise(
    vendors = n(),
    count_org_vendors = sum(org_vendor == 1, na.rm = TRUE),
    org_vendor_perc = count_org_vendors / vendors,
    median_org_products_count = median(org_products_count, na.rm = TRUE),
    iqr_org_products_count = IQR(org_products_count, na.rm = TRUE)
  ) %>%
  ungroup()

# Combine all three tables (neighbourhood, city, and country) into one
combined_tab2 <- bind_rows(
  tab2_neighbourhood %>%
    mutate(level = "Neighbourhood"),
  tab2_city %>%
    mutate(level = "City"),
  tab2_country %>%
    mutate(level = "Country")
)

# Create a custom order for the 'level' column to ensure Neighbourhood rows come first, then City, and then Country
combined_tab2$level <- factor(combined_tab2$level, levels = c("Neighbourhood", "City", "Country"))

# Sort the combined data by country, city, and the custom level order
tab2_final <- combined_tab2 %>%
  arrange(country, city, level)

# Merge columns
tab2_final <- tab2_final %>%
  mutate(
    org = paste0(count_org_vendors, " (", round(org_vendor_perc * 100, 2), "%)"),
    sentinels = paste0(median_org_products_count, " (", iqr_org_products_count, ")")
  ) %>%
  select(country, city, circle, vendors, org, sentinels)

# Print table
print(tab2_final)


# Export to table_outputs workbook
addWorksheet(table_outputs, "Table 2")
writeData(table_outputs, sheet = "Table 2", x = tab2_final)
saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)

```


#### Figure 1 - Availability by income-level

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Define order of neighbourhood variable
circle_order <- c("Higher","Middle","Lower")
  
# Convert the circle column to a factor with the specified levels
tab2_fig_data <- data_clean %>%
  mutate(circle = factor(circle, levels = circle_order)) %>%
  select(id, country, city, circle, org_vendor)

# Create table of neighbourhood data
tab2_fig_neighbourhood <- tab2_fig_data %>%
  group_by(country, city, circle) %>%
  summarise(
    vendors = n(),
    count_org_vendors = sum(org_vendor == 1, na.rm = TRUE),
    org_vendor_perc = count_org_vendors / vendors
  ) %>%
  ungroup()

# Create scatterplot stacked by country
ggplot(tab2_fig_neighbourhood, aes(x = circle, y = org_vendor_perc, color = circle)) +
  geom_point(size = 3, alpha = 0.8) +         # Scatter points
  facet_wrap(~ country, ncol = 1, scales = "free_y") +  # Facet countries in separate rows
  labs(
    x = "Neighbourhood",
    y = "Organic Vendor Percentage"
  ) +
  theme_light() +
  theme(
    strip.text = element_text(size = 12, face = "bold"),  # Country panel titles
    axis.text.x = element_text(angle = 45, hjust = 1),   # Rotated x-axis labels
    legend.position = "none"                             # Remove legend for 'Circle'
  )


# Export to table_outputs workbook
addWorksheet(table_outputs, "Table 2 - Figure")
writeData(table_outputs, sheet = "Table 2 - Figure", x = tab2_fig_neighbourhood)
saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)

```
















## 2. How affordable is a sentinel organic food (rice) compared to a non-organic sentinel food (rice) in urban food environments? How does this vary across different geographic contexts?

### Hypothesis 2a. The price of organic rice will be significantly higher than the price of non-organic rice overall and at the country level.


```{r include=FALSE}

# Load cleaned rice prices data
rice_prices_data <- read.xlsx("rice_prices_data_clean.xlsx", sheet = "data")

```

#### Wilcoxon Rank-Sum Test / Mann-Whitney U test

##### Overall results
```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame of overall prices
mw_rice_prices_data_overall <- rice_prices_data %>%
  select(rice_price_org_kg_usd, rice_price_conv_kg_usd)

# Reshape data to long form
reshaped_data <- mw_rice_prices_data_overall %>%
  pivot_longer(cols = c(rice_price_org_kg_usd, rice_price_conv_kg_usd), 
               names_to = "type", 
               values_to = "price") %>%
  mutate(type = ifelse(type == "rice_price_org_kg_usd", "organic", "conventional")) %>%
  filter(!is.na(price))

# Specify order because function otherwise sets first group alphabetically
reshaped_data$type <- factor(reshaped_data$type, 
                              levels = c("organic", "conventional"))

# Overall Mann-Whitney U test
overall_test <- wilcox.test(price ~ type, data = reshaped_data, 
                            alternative = "greater")

overall_p_value_one_tailed <- overall_test$p.value / 2

print(overall_test)
cat("Overall Mann-Whitney U test p-value (one-tailed):", overall_p_value_one_tailed, "\n")

```

##### Country-level results: Brazil
```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame of Brazil prices
mw_rice_prices_data_brazil <- rice_prices_data %>%
  select(country, rice_price_org_kg_usd, rice_price_conv_kg_usd) %>%
  filter(country == "Brazil")
  
# Reshape data to long form
reshaped_data_brazil <- mw_rice_prices_data_brazil %>%
  pivot_longer(cols = c(rice_price_org_kg_usd, rice_price_conv_kg_usd), 
               names_to = "type", 
               values_to = "price") %>%
  mutate(type = ifelse(type == "rice_price_org_kg_usd", "organic", "conventional")) %>%
  filter(!is.na(price))

# Specify order because function otherwise sets first group alphabetically
reshaped_data_brazil$type <- factor(reshaped_data_brazil$type, 
                              levels = c("organic", "conventional"))

# Brazil Mann-Whitney U test
brazil_test <- wilcox.test(price ~ type, data = reshaped_data_brazil, 
                            alternative = "greater")

brazil_p_value_one_tailed <- brazil_test$p.value / 2

print(brazil_test)
cat("Overall Mann-Whitney U test p-value (one-tailed):", brazil_p_value_one_tailed, "\n")

```


##### Country-level results: India
```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame of India prices
mw_rice_prices_data_india <- rice_prices_data %>%
  select(country, rice_price_org_kg_usd, rice_price_conv_kg_usd) %>%
  filter(country == "India")
  
# Reshape data to long form
reshaped_data_india <- mw_rice_prices_data_india %>%
  pivot_longer(cols = c(rice_price_org_kg_usd, rice_price_conv_kg_usd), 
               names_to = "type", 
               values_to = "price") %>%
  mutate(type = ifelse(type == "rice_price_org_kg_usd", "organic", "conventional")) %>%
  filter(!is.na(price))

# Specify order because function otherwise sets first group alphabetically
reshaped_data_india$type <- factor(reshaped_data_india$type, 
                              levels = c("organic", "conventional"))

# India Mann-Whitney U test
india_test <- wilcox.test(price ~ type, data = reshaped_data_india, 
                            alternative = "greater")

india_p_value_one_tailed <- india_test$p.value / 2

print(india_test)
cat("Overall Mann-Whitney U test p-value (one-tailed):", india_p_value_one_tailed, "\n")

```

##### Country-level results: UK
```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame of UK prices
mw_rice_prices_data_uk <- rice_prices_data %>%
  select(country, rice_price_org_kg_usd, rice_price_conv_kg_usd) %>%
  filter(country == "UK")
  
# Reshape data to long form
reshaped_data_uk <- mw_rice_prices_data_uk %>%
  pivot_longer(cols = c(rice_price_org_kg_usd, rice_price_conv_kg_usd), 
               names_to = "type", 
               values_to = "price") %>%
  mutate(type = ifelse(type == "rice_price_org_kg_usd", "organic", "conventional")) %>%
  filter(!is.na(price))

# Specify order because function otherwise sets first group alphabetically
reshaped_data_uk$type <- factor(reshaped_data_uk$type, 
                              levels = c("organic", "conventional"))

# UK Mann-Whitney U test
uk_test <- wilcox.test(price ~ type, data = reshaped_data_uk, 
                            alternative = "greater")

uk_p_value_one_tailed <- uk_test$p.value / 2

print(uk_test)
cat("Overall Mann-Whitney U test p-value (one-tailed):", uk_p_value_one_tailed, "\n")

```



### Hypothesis 2b. The price of organic rice will be significantly higher than the price of non-organic rice when sold at the same vendor location.

#### Wilcoxon Signed Rank Test

##### Overall results
```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame of rice prices for vendors selling both organic and conventional
wsr_rice_prices_data_overall <- rice_prices_data %>%
  select(rice_price_org_kg_usd, rice_price_conv_kg_usd, rice_price_both) %>%
  filter(rice_price_both == 1)

# Overall Wilcoxon Signed Rank test
wsr_overall_test <- wilcox.test(wsr_rice_prices_data_overall$rice_price_org_kg_usd,
                            wsr_rice_prices_data_overall$rice_price_conv_kg_usd,
                            alternative = "greater", paired = TRUE)

wsr_overall_p_value_one_tailed <- wsr_overall_test$p.value / 2

print(wsr_overall_test)
cat("Overall Wilcoxon Signed Rank test p-value (one-tailed):", wsr_overall_p_value_one_tailed, "\n")

```

##### Country-level results: Brazil
```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame of rice prices for vendors selling both organic and conventional
wsr_rice_prices_data_brazil <- rice_prices_data %>%
  select(country, rice_price_org_kg_usd, rice_price_conv_kg_usd, rice_price_both) %>%
  filter(rice_price_both == 1) %>%
  filter(country == "Brazil")

# Overall Wilcoxon Signed Rank test
wsr_brazil_test <- wilcox.test(wsr_rice_prices_data_brazil$rice_price_org_kg_usd,
                            wsr_rice_prices_data_brazil$rice_price_conv_kg_usd,
                            alternative = "greater", paired = TRUE)

wsr_brazil_p_value_one_tailed <- wsr_brazil_test$p.value / 2

print(wsr_brazil_test)
cat("Overall Wilcoxon Signed Rank test p-value (one-tailed):", wsr_brazil_p_value_one_tailed, "\n")

```


##### Country-level results: India
```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame of rice prices for vendors selling both organic and conventional
wsr_rice_prices_data_india <- rice_prices_data %>%
  select(country, rice_price_org_kg_usd, rice_price_conv_kg_usd, rice_price_both) %>%
  filter(rice_price_both == 1) %>%
  filter(country == "India")

# Overall Wilcoxon Signed Rank test
wsr_india_test <- wilcox.test(wsr_rice_prices_data_india$rice_price_org_kg_usd,
                            wsr_rice_prices_data_india$rice_price_conv_kg_usd,
                            alternative = "greater", paired = TRUE)

wsr_india_p_value_one_tailed <- wsr_india_test$p.value / 2

print(wsr_india_test)
cat("Overall Wilcoxon Signed Rank test p-value (one-tailed):", wsr_india_p_value_one_tailed, "\n")
```

##### Country-level results: UK
```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create data frame of rice prices for vendors selling both organic and conventional
wsr_rice_prices_data_uk <- rice_prices_data %>%
  select(country, rice_price_org_kg_usd, rice_price_conv_kg_usd, rice_price_both) %>%
  filter(rice_price_both == 1) %>%
  filter(country == "UK")

# Overall Wilcoxon Signed Rank test
wsr_uk_test <- wilcox.test(wsr_rice_prices_data_uk$rice_price_org_kg_usd,
                            wsr_rice_prices_data_uk$rice_price_conv_kg_usd,
                            alternative = "greater", paired = TRUE)

wsr_uk_p_value_one_tailed <- wsr_uk_test$p.value / 2

print(wsr_uk_test)
cat("Overall Wilcoxon Signed Rank test p-value (one-tailed):", wsr_uk_p_value_one_tailed, "\n")
```



### Figure 2 - country-level price boxplot


```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create new dataset in longer format
tab5_long <- rice_prices_data %>%
  select(id, country, rice_price_both, rice_price_conv_kg_usd, rice_price_org_kg_usd) %>%
  pivot_longer(
    cols = c(rice_price_conv_kg_usd, rice_price_org_kg_usd), # Select columns for conventional and organic prices
    names_to = "Type",
    values_to = "Price"
  ) %>%
  drop_na(Price) %>% # Remove rows where Price is NA
  mutate(Type = case_when(
    Type == "rice_price_conv_kg_usd" ~ "Conventional",
    Type == "rice_price_org_kg_usd" ~ "Organic"
  ))



# Create boxplot with points
ggplot(tab5_long, aes(x = country, y = Price, fill = Type)) +
  # Boxplot layer
  geom_boxplot(position = position_dodge(width = 0.8), outlier.shape = NA) +
  # Jittered points layer
  geom_jitter(
    position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.8),
    size = 0.5,
    color = "black"
  ) +
  # Customizations
  labs(
    x = "Country",
    y = "Price (per kg, USD)"
  ) +
  scale_fill_manual(
    values = c("Organic" = "skyblue", "Conventional" = "lightgreen") # Set custom colors
  )

# Save the plot
ggsave(
  filename = "boxplot_with_points.png", 
  path = "C:/Users/s1985751/Documents/GitHub/fea/Outputs",
  width = 8,
  height = 6,
  dpi = 300
)


# Create boxplot with medians labelled
ggplot(tab5_long, aes(x = country, y = Price, fill = Type)) +
  # Boxplot layer
  geom_boxplot(position = position_dodge(width = 0.8), outlier.shape = NA) +
#  # Jittered points layer
#  geom_jitter(
#    position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.8),
#    size = 1.5,
#    alpha = 0.6,
#    color = "black"
#  ) +
    # Add median labels
  stat_summary(
    fun = median,                                       # Function to calculate median
    geom = "text",                                      # Add as text labels
    aes(label = sprintf("%.2f", ..y..)),                # Format median to 2 decimal places
    position = position_dodge(width = 0.8),             # Ensure alignment with boxes
    vjust = -0.5,                                       # Adjust vertical position
    color = "black",                                    # Text color
    size = 3                                            # Text size
  ) +
  # Customizations
  labs(
    x = "Country",
    y = "Price (per kg, USD)"
  ) 

# Save the plot
ggsave(
  filename = "boxplot_medians.png", 
  path = "C:/Users/s1985751/Documents/GitHub/fea/Outputs",
  width = 8,
  height = 6,
  dpi = 300
)

# Create violin plot
ggplot(tab5_long, aes(x = country, y = Price, fill = Type)) +
  # Violin plot layer
  geom_violin(position = position_dodge(width = 0.8), outlier.shape = NA)


# Save the plot
ggsave(
  filename = "violinplot.png", 
  path = "C:/Users/s1985751/Documents/GitHub/fea/Outputs",
  width = 8,
  height = 6,
  dpi = 300
)  
  
# Export to table_outputs workbook
#addWorksheet(table_outputs, "Table 5 - country")
#writeData(table_outputs, sheet = "Table 5 - country", x = tab5_country)
#saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)

```




## 3. What are the marketing characteristics of organic food in urban food environments? How does this vary across different geographic and socioeconomic contexts? 

### Table 3 - Terminologies


```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create new instance of dataset for Table 6
tab6_data <- data_clean


# Vector of product abbreviations
products <- c("tom", "leaf", "ban", "man", "fj", "milk", "cof", "tea", "mill", "chic", "daal", "wht", "rice", "nut")


# Vector of countries
countries <- c("Brazil", "India", "UK", "Overall")


# Define a function to create the category summary for a given dataset
create_category_summary <- function(data) {
  
  # PRODUCT-LEVEL SUMMARY
  # Define a function to summarize data for a given product and dataset
  tab6_product_summary_list <- lapply(products, function(product) {
    data %>%
      summarise(
        org_count = sum(get(paste0(product, "_org")) == "Yes", na.rm = TRUE),
        term_organic_count = sum(get(paste0(product, "_org_terms_Organic")) == 1, na.rm = TRUE),
        term_organic_perc = term_organic_count / org_count,
        term_natural_count = sum(get(paste0(product, "_org_terms_Natural")) == 1, na.rm = TRUE),
        term_natural_perc = term_natural_count / org_count,
        term_chemfree_count = sum(get(paste0(product, "_org_terms_Chemical-free")) == 1, na.rm = TRUE),
        term_chemfree_perc = term_chemfree_count / org_count,
        term_pestfree_count = sum(get(paste0(product, "_org_terms_Pesticide-free")) == 1, na.rm = TRUE),
        term_pestfree_perc = term_pestfree_count / org_count,
        term_bioprod_count = sum(get(paste0(product, "_org_terms_Bioproducts")) == 1, na.rm = TRUE),
        term_bioprod_perc = term_bioprod_count / org_count,
        term_bio_count = sum(get(paste0(product, "_org_terms_Bio")) == 1, na.rm = TRUE),
        term_bio_perc = term_bio_count / org_count,
        term_eco_count = sum(get(paste0(product, "_org_terms_Eco")) == 1, na.rm = TRUE),
        term_eco_perc = term_eco_count / org_count,
        term_gmo_count = sum(get(paste0(product, "_org_terms_GMO-free")) == 1, na.rm = TRUE),
        term_gmo_perc = term_gmo_count / org_count,
        #term_dontknow_count = sum(get(paste0(product, "_org_terms_Don't know")) == 1, na.rm = TRUE),
        #term_dontknow_perc = term_dontknow_count / org_count
      ) %>%
      mutate(
        product = product,
        category = case_when(product %in% c("fj", "milk", "cof", "tea") ~ "beverages",
                             product %in% c("tom", "leaf", "ban", "man") ~ "fresh produce",
                             TRUE ~ "other")
        ) %>% 
      select(category, product, everything())
  })
  
  tab6_product_summary <- bind_rows(tab6_product_summary_list)

# Apply the function to each product and combine the results
#product_summary_list <- lapply(products, tab6_product_fn)
#tab6_product_summary <- bind_rows(product_summary_list)

  ## CATEGORY-LEVEL SUMMARY
  
  tab6_category_summary <- tab6_product_summary %>%
    group_by(category) %>%
    summarise(
      cat_org_count = sum(org_count, na.rm = TRUE),
      cat_term_organic_count = sum(term_organic_count, na.rm = TRUE),
      cat_term_organic_perc = cat_term_organic_count / cat_org_count,
      cat_term_natural_count = sum(term_natural_count, na.rm = TRUE),
      cat_term_natural_perc = cat_term_natural_count / cat_org_count,
      cat_term_chemfree_count = sum(term_chemfree_count, na.rm = TRUE),
      cat_term_chemfree_perc = cat_term_chemfree_count / cat_org_count,
      cat_term_pestfree_count = sum(term_pestfree_count, na.rm = TRUE),
      cat_term_pestfree_perc = cat_term_pestfree_count / cat_org_count,
      cat_term_bioprod_count = sum(term_bioprod_count, na.rm = TRUE),
      cat_term_bioprod_perc = cat_term_bioprod_count / cat_org_count,
      cat_term_bio_count = sum(term_bio_count, na.rm = TRUE),
      cat_term_bio_perc = cat_term_bio_count / cat_org_count,
      cat_term_eco_count = sum(term_eco_count, na.rm = TRUE),
      cat_term_eco_perc = cat_term_eco_count / cat_org_count,
      cat_term_gmo_count = sum(term_gmo_count, na.rm = TRUE),
      cat_term_gmo_perc = cat_term_gmo_count / cat_org_count,
      #term_dontknow_count = sum(term_dontknow_count, na.rm = TRUE),
      #term_dontknow_perc = mean(term_dontknow_perc, na.rm = TRUE)
    )

  # Calculate the totals across all categories
  totals_row <- tab6_category_summary %>%
    summarise(
      category = "Total",
      cat_org_count = sum(cat_org_count, na.rm = TRUE),
      cat_term_organic_count = sum(cat_term_organic_count, na.rm = TRUE),
      cat_term_organic_perc = cat_term_organic_count / cat_org_count,
      cat_term_natural_count = sum(cat_term_natural_count, na.rm = TRUE),
      cat_term_natural_perc = cat_term_natural_count / cat_org_count,
      cat_term_chemfree_count = sum(cat_term_chemfree_count, na.rm = TRUE),
      cat_term_chemfree_perc = cat_term_chemfree_count / cat_org_count,
      cat_term_pestfree_count = sum(cat_term_pestfree_count, na.rm = TRUE),
      cat_term_pestfree_perc = cat_term_pestfree_count / cat_org_count,
      cat_term_bioprod_count = sum(cat_term_bioprod_count, na.rm = TRUE),
      cat_term_bioprod_perc = cat_term_bioprod_count / cat_org_count,
      cat_term_bio_count = sum(cat_term_bio_count, na.rm = TRUE),
      cat_term_bio_perc = cat_term_bio_count / cat_org_count,
      cat_term_eco_count = sum(cat_term_eco_count, na.rm = TRUE),
      cat_term_eco_perc = cat_term_eco_count / cat_org_count,
      cat_term_gmo_count = sum(cat_term_gmo_count, na.rm = TRUE),
      cat_term_gmo_perc = cat_term_gmo_count / cat_org_count
      # term_dontknow_count = sum(term_dontknow_count, na.rm = TRUE),
      # term_dontknow_perc = mean(term_dontknow_perc, na.rm = TRUE)
    )

  # Append the totals row to the category summary table
  tab6_category_summary <- bind_rows(tab6_category_summary, totals_row)

  return(tab6_category_summary)
  
}


# Run the function for each country and combine results into one table
results_list <- lapply(countries, function(country) {
  if (country == "Overall") {
    data <- tab6_data
  } else {
    # Ensure filtering by country works
    data <- tab6_data %>% filter(country == !!country)
  }
  summary_table <- create_category_summary(data)
  summary_table %>%
    mutate(country = country) %>%
    select(country, everything())
})

# Combine all results
tab6_combined_summary <- bind_rows(results_list)

# Mutate to combine and clean up columns
tab6_combined_summary <- tab6_combined_summary %>%
    mutate(
      term_organic = paste0(cat_term_organic_count, " (", round(cat_term_organic_perc * 100), "%)"),
      term_natural = paste0(cat_term_natural_count, " (", round(cat_term_natural_perc * 100), "%)"),
      term_chemfree = paste0(cat_term_chemfree_count, " (", round(cat_term_chemfree_perc * 100), "%)"),
      term_pestfree = paste0(cat_term_pestfree_count, " (", round(cat_term_pestfree_perc * 100), "%)"),
      term_bioprod = paste0(cat_term_bioprod_count, " (", round(cat_term_bioprod_perc * 100), "%)"),
      term_bio = paste0(cat_term_bio_count, " (", round(cat_term_bio_perc * 100), "%)"),
      term_eco = paste0(cat_term_eco_count, " (", round(cat_term_eco_perc * 100), "%)"),
      term_gmo = paste0(cat_term_gmo_count, " (", round(cat_term_gmo_perc * 100), "%)")
    ) %>%
  select(country, category, cat_org_count, term_organic, term_natural,
         term_chemfree, term_pestfree, term_bioprod, term_bio, term_eco, term_gmo)

# View the final combined summary table
tab6_combined_summary

# Export to table_outputs workbook
addWorksheet(table_outputs, "Table 6")
writeData(table_outputs, sheet = "Table 6", x = tab6_combined_summary)
saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)

```










### Table 4 - Certification frequency

```{r echo = FALSE, message = FALSE, warning = FALSE}

# values per country
country <- data_clean %>%
  group_by(country) %>%
  summarise(Certified = sum(cert_count, na.rm = TRUE),
            Total = sum(org_products_count, na.rm = TRUE)) %>%
  mutate(Proportion = round(Certified/Total*100, 2)) %>%
  bind_rows(
    summarise(., 
              country = "Total", 
              Certified = sum(Certified), 
              Total = sum(Total), 
              Proportion = round(sum(Certified) / sum(Total) * 100, 2))
    )

# values per store type
vendortype <- data_clean %>%
  group_by(vendor_type)%>%
  summarise(Certified = sum(cert_count, na.rm = TRUE),
            Total = sum(org_products_count, na.rm = TRUE)) %>%
  mutate(Proportion = round(Certified/Total*100, 2))


# values per food
products <- c("tom", "leaf", "ban", "man", "fj", "milk", "cof", "tea", "mill", "chic", "daal", "wht", "rice", "nut")
vector_organics <- paste0(products, "_org")
vector_cert <- paste0(products, "_cert")


sentinelfood <- cbind(
  # count certifications
  data_clean %>%
    select(id, country, all_of(vector_cert)) %>%
    pivot_longer(cols = c(vector_cert), 
                 names_to = "food", 
                 values_to = c("certified")) %>%
    group_by(food) %>%
    summarise(Certified = sum(certified >= 1, na.rm=T)),
  
  # count all organics
  data_clean %>%
    select(id, country, all_of(vector_organics)) %>%
    pivot_longer(cols = c(vector_organics), 
                 names_to = "food", 
                 values_to = c("total")) %>%
    group_by(food) %>%
    summarise(Total = sum(total == "Yes", na.rm=T)) %>%
    select(-food)
) %>%
  mutate(Proportion = round(Certified/Total*100, 2))

kable(country)
kable(vendortype)
kable(sentinelfood)


# Export to table_outputs workbook
addWorksheet(table_outputs, "Table 8 - country")
writeData(table_outputs, sheet = "Table 8 - country", x = country)

addWorksheet(table_outputs, "Table 8 - vendortype")
writeData(table_outputs, sheet = "Table 8 - vendortype", x = vendortype)

addWorksheet(table_outputs, "Table 8 - sentinelfood")
writeData(table_outputs, sheet = "Table 8 - sentinelfood", x = sentinelfood)

saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)
```








## Extended Data

### Table E1

#### Exploratory Analysis: Organic versus non-organic vendor characteristics

##### Country-level

```{r echo = FALSE, message = FALSE, warning = FALSE}
# Summarize the data grouped by `org_vendor` and `country`

tab4_country_days <- data_clean %>%
  group_by(country, org_vendor, days_open_category) %>%
  summarise(vendor_count = n(), .groups = "drop") %>%
  pivot_wider(names_from = days_open_category, values_from = vendor_count, 
              values_fill = 0, # Fill missing combinations with 0
              names_prefix = "open_") %>%
  mutate(
    total_vendors = rowSums(select(., starts_with("open_"))),
    across(starts_with("open_"), ~ . / total_vendors * 100, .names = "percent_{col}"))


tab4_country <- data_clean %>%
  group_by(country, org_vendor) %>%
  summarize(
    median_vendor_cashiers = median(vendor_cashiers, na.rm = TRUE),
    iqr_vendor_cashiers = IQR(vendor_cashiers, na.rm = TRUE),
    min_vendor_cashiers = min(vendor_cashiers, na.rm = TRUE),
    max_vendor_cashiers = max(vendor_cashiers, na.rm = TRUE),
    
    median_foods_count = median(foods_count, na.rm = TRUE),
    iqr_foods_count = IQR(foods_count, na.rm = TRUE),
    min_foods_count = min(foods_count, na.rm = TRUE),
    max_foods_count = max(foods_count, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  left_join(tab4_country_days, by = c("country","org_vendor")) %>%
  mutate(
    vendor_cashiers_summary = paste0(median_vendor_cashiers, " (", iqr_vendor_cashiers, "), ", 
                                     min_vendor_cashiers, " - ", max_vendor_cashiers),
    foods_count_summary = paste0(median_foods_count, " (", iqr_foods_count, "), ",
                                 min_foods_count, " - ", max_foods_count),
    days_open_1_3_summary = paste0(`open_1-3`, " (", 
                                   ifelse(`percent_open_1-3` < 1, round(`percent_open_1-3`, 1), round(`percent_open_1-3`)), 
                                   "%)"),
    days_open_4_5_summary = paste0(`open_4-5`, " (", 
                                   ifelse(`percent_open_4-5` < 1, round(`percent_open_4-5`, 1), round(`percent_open_4-5`)), 
                                   "%)"),
    days_open_6_7_summary = paste0(`open_6-7`, " (", 
                                   ifelse(`percent_open_6-7` < 1, round(`percent_open_6-7`, 1), round(`percent_open_6-7`)), 
                                   "%)"),
  ) %>%
  select(country, org_vendor, vendor_cashiers_summary, days_open_1_3_summary, 
         days_open_4_5_summary, days_open_6_7_summary, foods_count_summary) %>%
  mutate(org_vendor = recode(org_vendor, '1' = 'Organic','0' = 'Non-organic'))

# Display the overall results
print(tab4_country)



# Export to table_outputs workbook
addWorksheet(table_outputs, "Table 4 - country")
writeData(table_outputs, sheet = "Table 4 - country", x = tab4_country)
saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)

```

##### Overall

```{r echo = FALSE, message = FALSE, warning = FALSE}
# Summarize the data for overall statistics grouped by `org_vendor`

tab4_overall_days <- data_clean %>%
  group_by(org_vendor, days_open_category) %>%
  summarise(vendor_count = n(), .groups = "drop") %>%
  pivot_wider(names_from = days_open_category, values_from = vendor_count, 
                  values_fill = 0, # Fill missing combinations with 0
                  names_prefix = "open_") %>%
  mutate(
    total_vendors = rowSums(select(., starts_with("open_"))),
    across(starts_with("open_"), ~ . / total_vendors * 100, .names = "percent_{col}"))


tab4_overall <- data_clean %>%
  group_by(org_vendor) %>%
  summarize(
    median_vendor_cashiers = median(vendor_cashiers, na.rm = TRUE),
    iqr_vendor_cashiers = IQR(vendor_cashiers, na.rm = TRUE),
    min_vendor_cashiers = min(vendor_cashiers, na.rm = TRUE),
    max_vendor_cashiers = max(vendor_cashiers, na.rm = TRUE),
    
    median_foods_count = median(foods_count, na.rm = TRUE),
    iqr_foods_count = IQR(foods_count, na.rm = TRUE),
    min_foods_count = min(foods_count, na.rm = TRUE),
    max_foods_count = max(foods_count, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  left_join(tab4_overall_days, by = "org_vendor") %>%
  mutate(
    vendor_cashiers_summary = paste0(median_vendor_cashiers, " (", iqr_vendor_cashiers, "), ", 
                                     min_vendor_cashiers, " - ", max_vendor_cashiers),
    foods_count_summary = paste0(median_foods_count, " (", iqr_foods_count, "), ",
                                 min_foods_count, " - ", max_foods_count),
    days_open_1_3_summary = paste0(`open_1-3`, " (", 
                                   ifelse(`percent_open_1-3` < 1, round(`percent_open_1-3`, 1), round(`percent_open_1-3`)), 
                                   "%)"),
    days_open_4_5_summary = paste0(`open_4-5`, " (", 
                                   ifelse(`percent_open_4-5` < 1, round(`percent_open_4-5`, 1), round(`percent_open_4-5`)), 
                                   "%)"),
    days_open_6_7_summary = paste0(`open_6-7`, " (", 
                                   ifelse(`percent_open_6-7` < 1, round(`percent_open_6-7`, 1), round(`percent_open_6-7`)), 
                                   "%)"),
  ) %>%
  select(org_vendor, vendor_cashiers_summary, days_open_1_3_summary, 
         days_open_4_5_summary, days_open_6_7_summary, foods_count_summary) %>%
  mutate(org_vendor = recode(org_vendor, '1' = 'Organic','0' = 'Non-organic'))

# Display the overall results
print(tab4_overall)


# Export to table_outputs workbook
addWorksheet(table_outputs, "Table 4 - overall")
writeData(table_outputs, sheet = "Table 4 - overall", x = tab4_overall)
saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)
```

### Table E2 - Availability by organic sentinel product

```{r echo = FALSE, message = FALSE, warning = FALSE}


# Create vectors
products <- c("tom", "leaf", "ban", "man", "fj", "milk", "cof", "tea", "mill", "chic", "daal", "wht", "rice", "nut")
vector_organics <- paste0(products, "_org")
vector_foods <- paste0(products, "_sell")
countries <- c("Brazil", "India", "UK", "Overall")

# Initialize a list to store results for each country
results <- list()

for (country in countries) {
  # Filter data for the current country or include all for "Overall"
  if (country == "Overall") {
    data_filtered <- data_clean
  } else {
    data_filtered <- data_clean %>% filter(country == !!country)
  }
  
  # Perform the calculations

  tabsx <- cbind(

    # Count all sentinel products
    data_filtered %>%
      select(id, country, all_of(vector_foods)) %>%
      pivot_longer(cols = c(vector_foods), 
                   names_to = "food_count", 
                   values_to = c("total")) %>%
      group_by(food_count) %>%
      summarise(total_count = sum(total == "Yes", na.rm=T)),
  
    # Count all organics per sentinel product
    data_filtered %>%
      select(id, country, all_of(vector_organics)) %>%
      pivot_longer(cols = c(vector_organics), 
                   names_to = "food_org", 
                   values_to = c("total")) %>%
      group_by(food_org) %>%
      summarise(total_org = sum(total == "Yes", na.rm=T))

  ) %>%
    mutate(perc_org = round(total_org/total_count*100, 2))

# Store the result in the list
  results[[country]] <- tabsx
}

# Access results for each country or overall
results[["Brazil"]]
results[["India"]]
results[["UK"]]
results[["Overall"]]



# Create a unified table with results from all countries and Overall
tabsx_final <- do.call(
  bind_rows,
  lapply(names(results), function(country) {
    results[[country]] %>%
      select(food_count = food_org, total_org, total_count, perc_org) %>%
      mutate(Country = country) # Add a column for the country name
  })
)

# Pivot to the desired format
tabsx_final_wide <- tabsx_final %>%
  pivot_wider(
    names_from = Country, # Use Country as column headers
    values_from = c(total_org, total_count, perc_org), # Expand these columns
    names_glue = "{Country}_{.value}" # Create compound column names
  ) %>%
  select(food_count, starts_with("Overall"), starts_with("Brazil"),
         starts_with("India"), starts_with("UK"))


# Calculate the totals for each numeric column
totals_row <- tabsx_final_wide %>%
  summarise(across(
    starts_with("Overall_total_org"):starts_with("UK_total_count"),
    ~ sum(.x, na.rm = TRUE)
  )) %>%
  mutate(
    food_count = "Total",
    Overall_perc_org = round(Overall_total_org / Overall_total_count * 100, 2),
    Brazil_perc_org = round(Brazil_total_org / Brazil_total_count * 100, 2),
    India_perc_org = round(India_total_org / India_total_count * 100, 2),
    UK_perc_org = round(UK_total_org / UK_total_count * 100, 2)
  )

# Bind the totals row to the bottom of the table
tabsx_final_totals <- bind_rows(tabsx_final_wide, totals_row)

# Select and combine columns
tabsx_final_output <- tabsx_final_totals %>%
  mutate(
    Overall = paste0(Overall_total_org, " (", Overall_perc_org, "%)"),
    Brazil = paste0(Brazil_total_org, " (", Brazil_perc_org, "%)"),
    India = paste0(India_total_org, " (", India_perc_org, "%)"),
    UK = paste0(UK_total_org, " (", UK_perc_org, "%)")
    ) %>%
  select(food_count, Overall, Brazil, India, UK)

# Display the final table with totals
tabsx_final_output



# Export to table_outputs workbook
addWorksheet(table_outputs, "Table 8 - country")
writeData(table_outputs, sheet = "Table 8 - country", x = country)

addWorksheet(table_outputs, "Table 8 - vendortype")
writeData(table_outputs, sheet = "Table 8 - vendortype", x = vendortype)

addWorksheet(table_outputs, "Table 8 - sentinelfood")
writeData(table_outputs, sheet = "Table 8 - sentinelfood", x = sentinelfood)

saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)
```



### Table E3

##### City-level

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Calculate number of organic and conventional vendors, median, IQR, min and max price
tab5_city_data <- rice_prices_data %>%
  group_by(country, city) %>%
  summarise(
    count_org_rice_vendors = sum(!is.na(rice_price_org_kg_usd)),
    count_conv_rice_vendors = sum(!is.na(rice_price_conv_kg_usd)),
    median_org_rice = median(rice_price_org_kg_usd, na.rm = TRUE),
    iqr_org_rice = IQR(rice_price_org_kg_usd, na.rm = TRUE),
    min_org_rice = min(rice_price_org_kg_usd, na.rm = TRUE),
    max_org_rice = max(rice_price_org_kg_usd, na.rm = TRUE),
    median_conv_rice = median(rice_price_conv_kg_usd, na.rm = TRUE),
    iqr_conv_rice = IQR(rice_price_conv_kg_usd, na.rm = TRUE),
    min_conv_rice = min(rice_price_conv_kg_usd, na.rm = TRUE),
    max_conv_rice = max(rice_price_conv_kg_usd, na.rm = TRUE),
  ) %>%
  ungroup()

# Create the gt table
tab5_city <- tab5_city_data %>%
  gt(rowname_col = "city", groupname_col = c("country")) %>%
  cols_label(
    country = "Country",
    city = "City",
    count_org_rice_vendors = "Organic sample size (n)",
    count_conv_rice_vendors = "Conventional sample size (n)",
    median_org_rice = "Organic median (IQR), min-max (US$)",
    iqr_org_rice = " ",
    min_org_rice = " ",
    max_org_rice = " ",
    median_conv_rice = "Conventional median (IQR), min-max (US$)",
    iqr_conv_rice = " ",
    min_conv_rice = " ",
    max_conv_rice = " "
  ) %>%
  cols_merge(
    columns = c("median_org_rice", "iqr_org_rice", "min_org_rice", "max_org_rice"),
    pattern = "{1} ({2}), {3}-{4}"
  ) %>%
    cols_merge(
    columns = c("median_conv_rice", "iqr_conv_rice", "min_conv_rice", "max_conv_rice"),
    pattern = "{1} ({2}), {3}-{4}"
  ) %>%
  fmt_number(
    columns = vars(median_org_rice, iqr_org_rice, min_org_rice, max_org_rice,
                   median_conv_rice, iqr_conv_rice, min_conv_rice, max_conv_rice),
    decimals = 2
  ) %>%
  summary_rows(
    groups = everything(),
    columns = vars(count_org_rice_vendors,count_conv_rice_vendors),
    fns = list(total = ~sum(., na.rm = TRUE)),
    formatter = fmt_number,
    decimals = 0,
  ) %>%
  sub_missing() 
  
# Display the table
tab5_city


# CREATE A BOXPLOT

# Create table in correct data format
tab5_boxplot <- tab5_city_data %>%
  # Calculate Q1 and Q3
  mutate(
    q1_org_rice = median_org_rice - (iqr_org_rice / 2),
    q3_org_rice = median_org_rice + (iqr_org_rice / 2),
    q1_conv_rice = median_conv_rice - (iqr_conv_rice / 2),
    q3_conv_rice = median_conv_rice + (iqr_conv_rice / 2),  
    ) %>%
  # Select necessary columns
  select(
    country, city, 
    min_org_rice, q1_org_rice, median_org_rice, q3_org_rice, max_org_rice,
    min_conv_rice, q1_conv_rice, median_conv_rice, q3_conv_rice, max_conv_rice
    ) %>%
  # Reshape into long format
  pivot_longer(
    cols = c(min_org_rice, q1_org_rice, median_org_rice, q3_org_rice, max_org_rice,
             min_conv_rice, q1_conv_rice, median_conv_rice, q3_conv_rice, max_conv_rice), # Include all relevant columns
    names_to = c(".value", "Type"),                # Separate names into '.value' (metrics) and 'Type'
    names_pattern = "(.*)_(org|conv)"              # Pattern: metric_(org|conv)
  )

# Create boxplot  
ggplot(tab5_boxplot, aes(x = city, fill = Type)) +
  geom_boxplot(
    aes(
      ymin = min,
      lower = q1,
      middle = median,
      upper = q3,
      ymax = max
    ),
    stat = "identity",
    #position = position_dodge(width = 0.8)
    position = position_dodge2(padding = 0.3) # Dodge to avoid overlapping between cities
  ) +
  facet_wrap(~ country, scales = "free_x") + # Separate panels by country
  labs(
    title = "Box Plot of Organic vs Conventional Rice Prices",
    x = "City",
    y = "Price (per kg, USD)"
  ) +
  scale_fill_manual(
    values = c("org" = "skyblue", "conv" = "lightgreen"),
    labels = c("Organic", "Conventional")
  ) +
  scale_x_discrete(
    expand = expansion(add = 0.5) # Add padding to ensure gridlines align with city boundaries
  ) +
  theme_light() +
  theme(
    panel.grid.major.x = element_line(color = "gray", size = 0.5), # Adjust gridlines
    panel.grid.minor.x = element_blank(),                         # Remove minor gridlines
    axis.text.x = element_text(angle = 45, hjust = 1), # Rotated x-axis labels
    strip.text = element_text(size = 12, face = "bold"), # Facet titles
    legend.position = "bottom", # Move legend to the bottom
    legend.title = element_blank() # Remove legend title
  )
  
# need to extend the y-axis for visibility






# Export to table_outputs workbook
addWorksheet(table_outputs, "Table 5 - city")
writeData(table_outputs, sheet = "Table 5 - city", x = tab5_city)
saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)

```

##### Country-level


```{r echo = FALSE, message = FALSE, warning = FALSE}

# Calculate number of organic and conventional vendors, median, IQR, min and max price
tab5_country_data <- rice_prices_data %>%
  group_by(country) %>%
  summarise(
    count_org_rice_vendors = sum(!is.na(rice_price_org_kg_usd)),
    count_conv_rice_vendors = sum(!is.na(rice_price_conv_kg_usd)),
    median_org_rice = median(rice_price_org_kg_usd, na.rm = TRUE),
    iqr_org_rice = IQR(rice_price_org_kg_usd, na.rm = TRUE),
    min_org_rice = min(rice_price_org_kg_usd, na.rm = TRUE),
    max_org_rice = max(rice_price_org_kg_usd, na.rm = TRUE),
    median_conv_rice = median(rice_price_conv_kg_usd, na.rm = TRUE),
    iqr_conv_rice = IQR(rice_price_conv_kg_usd, na.rm = TRUE),
    min_conv_rice = min(rice_price_conv_kg_usd, na.rm = TRUE),
    max_conv_rice = max(rice_price_conv_kg_usd, na.rm = TRUE),
  ) %>%
  ungroup()

tab5_country <- tab5_country_data %>%
  gt() %>%
  cols_label(
    country = "Country",
    count_org_rice_vendors = "Organic sample size (n)",
    count_conv_rice_vendors = "Conventional sample size (n)",
    median_org_rice = "Organic median (IQR), min-max (US$)",
    iqr_org_rice = " ",
    min_org_rice = " ",
    max_org_rice = " ",
    median_conv_rice = "Conventional median (IQR), min-max (US$)",
    iqr_conv_rice = " ",
    min_conv_rice = " ",
    max_conv_rice = " "
  ) %>%
  cols_merge(
    columns = c("median_org_rice", "iqr_org_rice", "min_org_rice", "max_org_rice"),
    pattern = "{1} ({2}), {3}-{4}"
  ) %>%
    cols_merge(
    columns = c("median_conv_rice", "iqr_conv_rice", "min_conv_rice", "max_conv_rice"),
    pattern = "{1} ({2}), {3}-{4}"
  ) %>%
  fmt_number(
    columns = vars(median_org_rice, iqr_org_rice, min_org_rice, max_org_rice,
                   median_conv_rice, iqr_conv_rice, min_conv_rice, max_conv_rice),
    decimals = 2
  ) %>%
  grand_summary_rows(
    columns = vars(count_org_rice_vendors,count_conv_rice_vendors),
    fns = list(total = ~sum(., na.rm = TRUE)),
    formatter = fmt_number,
    decimals = 0,
  ) %>%
  sub_missing() 

# Display the table
tab5_country


# Export to table_outputs workbook
addWorksheet(table_outputs, "Table 5 - country")
writeData(table_outputs, sheet = "Table 5 - country", x = tab5_country)
saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)

```

##### Overall


```{r echo = FALSE, message = FALSE, warning = FALSE}

# Calculate number of organic and conventional vendors, median, IQR, min and max price
tab5_overall_data <- rice_prices_data %>%
  summarise(
    count_org_rice_vendors = sum(!is.na(rice_price_org_kg_usd)),
    count_conv_rice_vendors = sum(!is.na(rice_price_conv_kg_usd)),
    median_org_rice = median(rice_price_org_kg_usd, na.rm = TRUE),
    iqr_org_rice = IQR(rice_price_org_kg_usd, na.rm = TRUE),
    min_org_rice = min(rice_price_org_kg_usd, na.rm = TRUE),
    max_org_rice = max(rice_price_org_kg_usd, na.rm = TRUE),
    median_conv_rice = median(rice_price_conv_kg_usd, na.rm = TRUE),
    iqr_conv_rice = IQR(rice_price_conv_kg_usd, na.rm = TRUE),
    min_conv_rice = min(rice_price_conv_kg_usd, na.rm = TRUE),
    max_conv_rice = max(rice_price_conv_kg_usd, na.rm = TRUE),
  ) %>%
  ungroup()

# Create gt table
tab5_overall <- tab5_overall_data %>%
  gt() %>%
  cols_label(
    count_org_rice_vendors = "Organic sample size (n)",
    count_conv_rice_vendors = "Conventional sample size (n)",
    median_org_rice = "Organic median (IQR), min-max (US$)",
    iqr_org_rice = " ",
    min_org_rice = " ",
    max_org_rice = " ",
    median_conv_rice = "Conventional median (IQR), min-max (US$)",
    iqr_conv_rice = " ",
    min_conv_rice = " ",
    max_conv_rice = " "
  ) %>%
  cols_merge(
    columns = c("median_org_rice", "iqr_org_rice", "min_org_rice", "max_org_rice"),
    pattern = "{1} ({2}), {3}-{4}"
  ) %>%
    cols_merge(
    columns = c("median_conv_rice", "iqr_conv_rice", "min_conv_rice", "max_conv_rice"),
    pattern = "{1} ({2}), {3}-{4}"
  ) %>%
  fmt_number(
    columns = vars(median_org_rice, iqr_org_rice, min_org_rice, max_org_rice,
                   median_conv_rice, iqr_conv_rice, min_conv_rice, max_conv_rice),
    decimals = 2
  ) %>%
  sub_missing() 

# Display the table
tab5_overall

# Export to table_outputs workbook
addWorksheet(table_outputs, "Table 5 - overall")
writeData(table_outputs, sheet = "Table 5 - overall", x = tab5_overall)
saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)

```

### Table E4 - Certification types

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create new instance of dataset for Table 9
tab9_data <- data_clean


# Export data for manual clean up of other certifications

tab9_data_export <- tab9_data %>%
  select(id, country, city, contains("_org_certif"))

certifications <- createWorkbook()
addWorksheet(certifications, "Certifications")
writeData(certifications, sheet = "Certifications", x = tab9_data_export)
saveWorkbook(certifications, "C:/Users/s1985751/Documents/GitHub/fea/certifications.xlsx", overwrite = TRUE)


# Import cleaned data
tab9_cert_clean <- read.xlsx("~/GitHub/fea/Outputs/certifications_clean.xlsx", sheet = "Certifications")


# Join with certification count columns
tab9_cert_data <- left_join(
  tab9_cert_clean %>%
    select(id, country, everything()),
  tab9_data %>%
    select(id, country, ban_cert, chic_cert, cof_cert, wht_cert, fj_cert, leaf_cert, 
           daal_cert, man_cert, milk_cert, mill_cert, nut_cert, rice_cert, tea_cert, tom_cert))


# Vector with certification types variables without other columns
vector_certifcols <- tab9_cert_data %>% 
  select(contains("_org_certif")) %>%
  select(-matches("_org_certif_None|_org_certif_other_1|_org_certif_other_2|_org_certif_other_3|_org_certif_other_4|_org_certif_other_5")) %>%
  names()

# Vector of product abbreviations
products <- c("ban","chic","cof","wht","fj","leaf","daal","man","milk","mill","nut","rice","tea","tom")

# Define a function to summarise number of certification types
tab9_product_fn <- function(product) {
  tab9_cert_data %>%
    group_by(country) %>%
    summarise(overall_cert_count = sum(get(paste0(product, "_cert")) == 1)) %>%
    mutate(product= product) %>%
    select(product, everything())
}


# Create table without other options
tab9a <- left_join(
  
  # Number of products with each certification type
  certification_clean %>%
    select(country, all_of(vector_certifcols)) %>%
    pivot_longer(
      cols = all_of(vector_certifcols),
      names_to = "certification_type",
      values_to = "value"
    ) %>%
    group_by(country, certification_type) %>%
    summarise(cert_type_count = sum(!is.na(value) & value == 1, na.rm = TRUE), .groups = 'drop') %>%
    mutate(
      product = sub("_.*", "", certification_type),
      certification_name = gsub("(?<=[a-zA-Z])\\.(?=[a-zA-Z])", " ", sub(".*_", "", certification_type), perl = TRUE)
      ) %>%
    group_by(country, product) %>%
    arrange(country, product, desc(cert_type_count)) %>%
    #slice(1:3) %>%
    mutate(rank = row_number()) %>%
    select(product, country, everything()),
  # Apply the function to create a table with list of certification types and their number
  tab9a_combined <- lapply(products, tab9_product_fn) %>%
    bind_rows() 
) %>%
  
  # Combine and clean up variables
  mutate(product = paste(product, rank)#,
         #perc = round((cert_type_count/overall_cert_count)*100, 2),
         #certification = ifelse(cert_type_count == 0, NA, paste0(certification_name, " (", cert_type_count, ", ", perc, "%)"))
         ) %>%
  select(country, product, overall_cert_count, certification_name, cert_type_count) %>%
  # Sort by product column alphabetically
  arrange(country, product)


addWorksheet(certifications, "Table 9A")
writeData(certifications, sheet = "Table 9A", x = tab9a)
saveWorkbook(certifications, "C:/Users/s1985751/Documents/GitHub/fea/certifications.xlsx", overwrite = TRUE)

```


### Table E5 - Discounts


```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create new instance of dataset for Table 14
tab14_data <- data_clean %>%
  select(country, org_products_count, tom_org_discount, leaf_org_discount, ban_org_discount, man_org_discount,
         fj_org_discount, milk_org_discount, cof_org_discount, tea_org_discount, mill_org_discount, 
         chic_org_discount, daal_org_discount, wht_org_discount, rice_org_discount, nut_org_discount)


discount_vector <- c("tom_org_discount", "leaf_org_discount", "ban_org_discount", "man_org_discount",
         "fj_org_discount", "milk_org_discount", "cof_org_discount", "tea_org_discount", "mill_org_discount", 
         "chic_org_discount", "daal_org_discount", "wht_org_discount", "rice_org_discount", "nut_org_discount")
  
tab14_data <- tab14_data %>%
  mutate(discount_count = rowSums(select(., all_of(discount_vector)) == "Yes", na.rm = TRUE))

# Create a table that summarises the number and percentage of organic sentinel products with a discount
tab14 <- tab14_data %>%
  group_by(country) %>%
  summarise(
    discount = sum(discount_count, na.rm = TRUE),
    org_count = sum(org_products_count, na.rm = TRUE),
    discount_perc = round((discount/org_count)*100, 2)
  )

# Calculate 'Overall' row by summing all countries together
overall_row <- tab14_data %>%
  summarise(
    country = "Overall",  # Add "Overall" label
    discount = sum(discount_count, na.rm = TRUE),
    org_count = sum(org_products_count, na.rm = TRUE),
    discount_perc = round((discount/org_count)*100, 2)
  ) 

# Bind the 'Overall' row to the original table
tab14 <- bind_rows(tab14, overall_row) %>%
  select(country, discount, org_count, discount_perc)



# Export to table_outputs workbook
addWorksheet(table_outputs, "Table 14")
writeData(table_outputs, sheet = "Table 14", x = tab14)
saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)

```





### Table E6 - Product positioning


```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create new instance of dataset for Table 12
tab12_data <- data_clean

# Vector of products and countries
products <- c("tom", "leaf", "ban", "man", "fj", "milk", "cof", "tea", "mill", "chic", "daal", "wht", "rice", "nut")
countries <- c("Brazil", "India", "UK", "Overall")

# Define a function to summarize data for a given product, dataset, and country
product_position_fn <- function(data, product) {
  data %>%
    summarise(
      org_count = sum(get(paste0(product, "_org")) == "Yes", na.rm = TRUE),
      clustered_count = sum(get(paste0(product, "_org_arranged")) == "Clustered (alongside other organic and/or natural products)", na.rm = TRUE),
      dispersed_count = sum(get(paste0(product, "_org_arranged")) == "Dispersed (alongside conventional products of the same category)", na.rm = TRUE),
      mostlyorg_count = sum(get(paste0(product, "_org_arranged")) == "Most of the store is organic/natural", na.rm = TRUE)
    ) %>%
    mutate(
      product = product,
      clustered_perc = round((clustered_count / org_count) * 100, 2),
      dispersed_perc = round((dispersed_count / org_count) * 100, 2),
      mostlyorg_perc = round((mostlyorg_count / org_count) * 100, 2)
    )
}

# Create a list to hold each country's data
results_list <- lapply(countries, function(country) {
  # Filter data by country
  if (country == "Overall") {
    data <- tab12_data  # Use overall data for the "Overall" case
  } else {
    data <- tab12_data %>% filter(country == !!country)  # Ensure 'country' matches the actual column name in your dataset
  }
  
  # Create a summary for each product within the country
  product_summaries <- lapply(products, function(product) {
    product_position_fn(data, product) %>%
      mutate(country = country)
  })
  
  # Combine all product summaries for the country
  bind_rows(product_summaries)
})

# Combine all country summaries into one data frame
tab12_product_position <- bind_rows(results_list)

# Calculate totals
tab12_totals <- tab12_product_position %>%
  group_by(country) %>%
  summarise(
    org_count = sum(org_count, na.rm = TRUE),
    clustered_count = sum(clustered_count, na.rm = TRUE),
    dispersed_count = sum(dispersed_count, na.rm = TRUE),
    mostlyorg_count = sum(mostlyorg_count, na.rm = TRUE)
  ) %>%
  mutate(
    product = "Total",
    clustered_perc = round((clustered_count / org_count) * 100, 2),
    dispersed_perc = round((dispersed_count / org_count) * 100, 2),
    mostlyorg_perc = round((mostlyorg_count / org_count) * 100, 2)
  )

# Add totals row
tab12_product_with_total <- bind_rows(tab12_product_position, tab12_totals)

# Combine columns
tab12_product_with_total <- tab12_product_with_total %>%
  mutate(
    clustered = paste0(clustered_count, " (", clustered_perc, "%)"),
    dispersed = paste0(dispersed_count, " (", dispersed_perc, "%)"),
    mostlyorg = paste0(mostlyorg_count, " (", mostlyorg_perc, "%)")
  ) %>%
  select(product, country, clustered, dispersed, mostlyorg)

# Reshape data to create a separate column for each country and sub-columns for clustered, dispersed, and mostlyorg
tab12 <- tab12_product_with_total %>%
  pivot_wider(
    id_cols = product,
    names_from = country,
    values_from = c(clustered, dispersed, mostlyorg),
    names_glue = "{country}_{.value}"  # This creates sub-columns for each country and type
  ) %>%
  select(product, Overall_clustered, Overall_dispersed, Overall_mostlyorg,
         Brazil_clustered, Brazil_dispersed, Brazil_mostlyorg,
         India_clustered, India_dispersed, India_mostlyorg,
         UK_clustered, UK_dispersed, UK_mostlyorg,
  )

# View the final table with totals row
tab12


# Export to table_outputs workbook
addWorksheet(table_outputs, "Table 12")
writeData(table_outputs, sheet = "Table 12", x = tab12)
saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)

```



### Table E7 - Product positioning


```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create new instance of dataset for Table 13
tab13_data <- data_clean

# 1. Create table that counts the number of sentinel products for each STORE position

  # Create summary columns
  
  tab13a <- tab13_data %>%
    select(country, org_products_count, store_pos_front_count, store_pos_mid_count, store_pos_back_count) %>%
    group_by(country) %>%
    summarise(
      org_count = sum(org_products_count, na.rm = TRUE),
      front_count = sum(store_pos_front_count, na.rm = TRUE),
      front_perc = round((front_count/org_count)*100, 2),
      mid_count = sum(store_pos_mid_count, na.rm = TRUE),
      mid_perc = round((mid_count/org_count)*100, 2),
      back_count = sum(store_pos_back_count, na.rm = TRUE),
      back_perc = round((back_count/org_count)*100, 2)
    )
  
  # Calculate 'Overall' row by summing all countries together
  overall_row <- tab13_data %>%
    summarise(
      country = "Overall",  # Add "Overall" label
      org_count = sum(org_products_count, na.rm = TRUE),
      front_count = sum(store_pos_front_count, na.rm = TRUE),
      front_perc = round((front_count / org_count) * 100, 2),
      mid_count = sum(store_pos_mid_count, na.rm = TRUE),
      mid_perc = round((mid_count / org_count) * 100, 2),
      back_count = sum(store_pos_back_count, na.rm = TRUE),
      back_perc = round((back_count / org_count) * 100, 2)
    ) 
  
  # Bind the 'Overall' row to the original table
  tab13a <- bind_rows(tab13a, overall_row) %>%
    select(country, front_count, front_perc, mid_count, mid_perc, back_count, back_perc) %>%
    # Pivot to longer format to consolidate absolute and relative columns by position
    pivot_longer(
      cols = -country,
      names_to = c("Store_Position", ".value"),
      names_sep = "_"
    ) %>% 
    # Pivot to wider format to make countries into columns with count and perc as sub-columns
    pivot_wider(
      names_from = country,
      values_from = c(count, perc),
      names_glue = "{country}_{.value}"
    ) 
  
  # Reorder columns
  tab13a <- tab13a %>%
    select(Store_Position, Overall_count, Overall_perc, Brazil_count, Brazil_perc,
           India_count, India_perc, UK_count, UK_perc)
  
  # View the final table
  tab13a

# 2. Create table that counts the number of sentinel products for each SHELF position

  # Create summary columns
  
  tab13b <- tab13_data %>%
    select(country, org_products_count, shelf_pos_upper_count, shelf_pos_mid_count, shelf_pos_lower_count) %>%
    group_by(country) %>%
    summarise(
      org_count = sum(org_products_count, na.rm = TRUE),
      upper_count = sum(shelf_pos_upper_count, na.rm = TRUE),
      upper_perc = round((upper_count/org_count)*100, 2),
      mid_count = sum(shelf_pos_mid_count, na.rm = TRUE),
      mid_perc = round((mid_count/org_count)*100, 2),
      lower_count = sum(shelf_pos_lower_count, na.rm = TRUE),
      lower_perc = round((lower_count/org_count)*100, 2)
    )
  
  # Calculate 'Overall' row by summing all countries together
  overall_row <- tab13_data %>%
    summarise(
      country = "Overall",  # Add "Overall" label
      org_count = sum(org_products_count, na.rm = TRUE),
      upper_count = sum(shelf_pos_upper_count, na.rm = TRUE),
      upper_perc = round((upper_count / org_count) * 100, 2),
      mid_count = sum(shelf_pos_mid_count, na.rm = TRUE),
      mid_perc = round((mid_count / org_count) * 100, 2),
      lower_count = sum(shelf_pos_lower_count, na.rm = TRUE),
      lower_perc = round((lower_count / org_count) * 100, 2)
    ) 
  
  # Bind the 'Overall' row to the original table
  tab13b <- bind_rows(tab13b, overall_row) %>%
    select(country, upper_count, upper_perc, mid_count, mid_perc, lower_count, lower_perc) %>%
    # Pivot to longer format to consolidate absolute and relative columns by position
    pivot_longer(
      cols = -country,
      names_to = c("Shelf_Position", ".value"),
      names_sep = "_"
    ) %>% 
    # Pivot to wider format to make countries into columns with count and perc as sub-columns
    pivot_wider(
      names_from = country,
      values_from = c(count, perc),
      names_glue = "{country}_{.value}"
    ) 
  
  # Reorder columns
  tab13b <- tab13b %>%
    select(Shelf_Position, Overall_count, Overall_perc, Brazil_count, Brazil_perc,
           India_count, India_perc, UK_count, UK_perc)
  
  # View the final table
  tab13b
  

# Export to table_outputs workbook
addWorksheet(table_outputs, "Table 13a")
writeData(table_outputs, sheet = "Table 13a", x = tab13a)
addWorksheet(table_outputs, "Table 13b")
writeData(table_outputs, sheet = "Table 13b", x = tab13b)
saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)

```



### Table E8 - Brands

```{r echo = FALSE, message = FALSE, warning = FALSE}

# vector with brand names variables
vector_brandnames <- data_clean %>% 
  select(contains("brand_new")) %>%
  names()

tab7 <- left_join(
  # number of brands in each sentinel food
  data_clean %>%
    select(country, vector_brandnames) %>%
    pivot_longer(cols = c(vector_brandnames), 
                 names_to = "food", 
                 values_to = "brand") %>%
    filter(!is.na(brand)) %>%
    group_by(country, food) %>%
    summarise(n_brands = n()),
  
  # top three brands for each sentinel food
  data_clean %>%
    select(country, vector_brandnames) %>%
    pivot_longer(cols = c(vector_brandnames), 
                 names_to = "food", 
                 values_to = "brand") %>%
    filter(!is.na(brand), brand != "Unbranded") %>%
    group_by(country, food) %>%
    count(brand) %>%
    arrange(desc(n), .by_group = TRUE) %>%
    slice(1:3) %>%
    mutate(rank = row_number())
) %>%
  # adjust variables
  mutate(food = paste(food, rank),
         perc = round((n/n_brands)*100, 2),
         brand = paste0(brand, " (", n, ", ", perc, "%)")) %>%
  select(country, food, brand) %>%
   # sort by 'food' column alphabetically
  arrange(food) %>% 
  # reshape table to match the analysis plan
  pivot_wider(names_from = country,
              values_from = brand)

kable(tab7)

# Export to table_outputs workbook
addWorksheet(table_outputs, "Table 7")
writeData(table_outputs, sheet = "Table 7", x = tab7)
saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)
```


### Table E9 - Themes

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create new instance of dataset for Table 10
tab10_data <- data_clean


# Vector with theme count variables
vector_themes <- tab10_data %>% 
  select(contains("theme_")) %>%
  select(-matches("theme_na_count|theme_none_count|theme_other_count|promo_theme")) %>%
  names()

# Create the country-level summary table

tab10_main <- tab10_data %>%
  select(country, org_products_count, all_of(vector_themes)) %>%
  pivot_longer(
    cols = all_of(vector_themes),
    names_to = "theme",
    values_to = "value"
  ) %>%
  group_by(country, theme) %>%
  summarise(
    theme_count = sum(value, na.rm = TRUE), 
    org_count = sum(org_products_count, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(perc = round((theme_count / org_count)*100,2)) %>%
  select(country, theme, theme_count, perc)

# Create the overall summary table

tab10_overall <- tab10_data %>%
  select(org_products_count, all_of(vector_themes)) %>%
  pivot_longer(
    cols = all_of(vector_themes),
    names_to = "theme",
    values_to = "value"
  ) %>%
  group_by(theme) %>%
  summarise(
    theme_count = sum(value, na.rm = TRUE), 
    org_count = sum(org_products_count, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    perc = round((theme_count / org_count)*100,2),
    country = paste0("Overall")
    ) %>%
  select(country, theme, theme_count, perc)


# Combine the main data with the overall summary
tab10 <- bind_rows(tab10_main, tab10_overall) %>%
  # Pivot wider to make countries as columns with theme_count and perc as sub-columns
  pivot_wider(
    names_from = country,
    values_from = c(theme_count, perc),
  ) %>%
  arrange(theme) %>%
  select(theme, theme_count_Overall, perc_Overall, theme_count_Brazil, perc_Brazil, 
         theme_count_India, perc_India, theme_count_UK, perc_UK)


# Export to table_outputs workbook
addWorksheet(table_outputs, "Table 10")
writeData(table_outputs, sheet = "Table 10", x = tab10)
saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)
```


### Table E10 - Promotional materials

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Create new instance of dataset for Table 11
tab11_data <- data_clean


## 1. FREQUENCY OF PROMOTIONAL MATERIALS

# Create a table summarising the frequency of promotional materials

tab11a <- tab11_data %>%
  group_by(country) %>%
  summarise(
    promo_count = sum(promo_count, na.rm = TRUE),
    org_count = sum(org_products_count, na.rm = TRUE)
  ) %>%
  mutate(
    perc = round((promo_count/org_count)*100,2)
  ) %>%
  bind_rows(
    summarise(
      .,
      country = "Overall",
      promo_count = sum(promo_count, na.rm = TRUE),
      org_count = sum(org_count, na.rm = TRUE),
      perc = round((sum(promo_count, na.rm = TRUE) / sum(org_count, na.rm = TRUE)) * 100, 2)
    )
  ) %>%
  select(country, promo_count, perc) %>%
  pivot_wider(
    names_from = country,
    values_from = c(promo_count, perc)
  ) %>%
  select(promo_count_Overall, perc_Overall, promo_count_Brazil, perc_Brazil,
         promo_count_India, perc_India, promo_count_UK, perc_UK)


## 2. TYPES OF PROMOTIONAL MATERIALS


# Vector with promotional type count variables
vector_type_promo <- tab11_data %>% 
  select(contains("promo_type_")) %>%
  select(-matches("org_promo_type|promo_type_other")) %>%
  names()

# Create the country-level summary table

tab11b_main <- tab11_data %>%
  select(country, promo_count, all_of(vector_type_promo)) %>%
  filter(promo_count > 0 | is.na(promo_count)) %>% 
  pivot_longer(
    cols = all_of(vector_type_promo),
    names_to = "type",
    values_to = "value"
  ) %>%
  group_by(country, type) %>%
  summarise(
    type_count = sum(value, na.rm = TRUE), 
    promo_count = sum(promo_count, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(perc = round((type_count / promo_count)*100,2)) %>%
  select(country, type, type_count, perc)


# Create the overall summary table

tab11b_overall <- tab11_data %>%
  select(promo_count, all_of(vector_type_promo)) %>%
  pivot_longer(
    cols = all_of(vector_type_promo),
    names_to = "type",
    values_to = "value"
  ) %>%
  group_by(type) %>%
  summarise(
    type_count = sum(value, na.rm = TRUE), 
    promo_count = sum(promo_count, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    perc = round((type_count / promo_count)*100,2),
    country = paste0("Overall")
    ) %>%
  select(country, type, type_count, perc)


# Combine the main data with the overall summary
tab11b <- bind_rows(tab11b_main, tab11b_overall) %>%
  # Pivot wider to make countries as columns with theme_count and perc as sub-columns
  pivot_wider(
    names_from = country,
    values_from = c(type_count, perc),
  ) %>%
  arrange(type) %>%
  select(type, type_count_Overall, perc_Overall, type_count_Brazil, perc_Brazil, 
         type_count_India, perc_India, type_count_UK, perc_UK)



## 3. THEMES OF PROMOTIONAL MATERIALS

# Vector with promotional theme count variables
vector_themes_promo <- tab11_data %>% 
  select(contains("promo_theme_")) %>%
  select(-matches("promo_theme_other_count")) %>%
  names()

# Create the country-level summary table

tab11c_main <- tab11_data %>%
  select(country, promo_count, all_of(vector_themes_promo)) %>%
  filter(promo_count > 0 | is.na(promo_count)) %>% # Keep only rows with at least one product with a promotion
  pivot_longer(
    cols = all_of(vector_themes_promo),
    names_to = "theme",
    values_to = "value"
  ) %>%
  group_by(country, theme) %>%
  summarise(
    theme_count = sum(value, na.rm = TRUE), 
    promo_count = sum(promo_count, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(perc = round((theme_count / promo_count)*100,2)) %>%
  select(country, theme, theme_count, perc)


# Create the overall summary table

tab11c_overall <- tab11_data %>%
  select(promo_count, all_of(vector_themes_promo)) %>%
  pivot_longer(
    cols = all_of(vector_themes_promo),
    names_to = "theme",
    values_to = "value"
  ) %>%
  group_by(theme) %>%
  summarise(
    theme_count = sum(value, na.rm = TRUE), 
    promo_count = sum(promo_count, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    perc = round((theme_count / promo_count)*100,2),
    country = paste0("Overall")
    ) %>%
  select(country, theme, theme_count, perc)


# Combine the main data with the overall summary
tab11c <- bind_rows(tab11c_main, tab11c_overall) %>%
  # Pivot wider to make countries as columns with theme_count and perc as sub-columns
  pivot_wider(
    names_from = country,
    values_from = c(theme_count, perc),
  ) %>%
  arrange(theme) %>%
  select(theme, theme_count_Overall, perc_Overall, theme_count_Brazil, perc_Brazil, 
         theme_count_India, perc_India, theme_count_UK, perc_UK)


# Export to table_outputs workbook
addWorksheet(table_outputs, "Table 11a")
writeData(table_outputs, sheet = "Table 11a", x = tab11a)

addWorksheet(table_outputs, "Table 11b")
writeData(table_outputs, sheet = "Table 11b", x = tab11b)

addWorksheet(table_outputs, "Table 11c")
writeData(table_outputs, sheet = "Table 11c", x = tab11c)

saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)
```










## Supplementary Information

### Table S1 - Availability without beverages

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Define order of neighbourhood variable
circle_order <- c("Higher","Middle","Lower")
  
# Convert the circle column to a factor with the specified levels
tab2s_data <- data_clean %>%
  mutate(circle = factor(circle, levels = circle_order))

# Filter to only foods, not beverages

# Create table of neighbourhood data
tab2s_neighbourhood <- tab2s_data %>%
  group_by(country, city, circle) %>%
  summarise(
    vendors = n(),
    count_org_vendors_foodonly = sum(org_vendor_foodonly == 1, na.rm = TRUE),
    org_vendor_perc_foodonly = count_org_vendors_foodonly / vendors,
    median_org_products_count_foodonly = median(org_foodonly_count, na.rm = TRUE),
    iqr_org_products_count_foodonly = IQR(org_foodonly_count, na.rm = TRUE)
  ) %>%
  ungroup()

# Create city rows
tab2s_city <- tab2s_data %>%
  group_by(country, city) %>%
  summarise(
    vendors = n(),
    count_org_vendors_foodonly = sum(org_vendor_foodonly == 1, na.rm = TRUE),
    org_vendor_perc_foodonly = count_org_vendors_foodonly / vendors,
    median_org_products_count_foodonly = median(org_foodonly_count, na.rm = TRUE),
    iqr_org_products_count_foodonly = IQR(org_foodonly_count, na.rm = TRUE)
  ) %>%
  ungroup()

# Create country rows
tab2s_country <- tab2s_data %>%
  group_by(country) %>%
  summarise(
    vendors = n(),
    count_org_vendors_foodonly = sum(org_vendor_foodonly == 1, na.rm = TRUE),
    org_vendor_perc_foodonly = count_org_vendors_foodonly / vendors,
    median_org_products_count_foodonly = median(org_foodonly_count, na.rm = TRUE),
    iqr_org_products_count_foodonly = IQR(org_foodonly_count, na.rm = TRUE)
  ) %>%
  ungroup()

# Combine all three tables (neighbourhood, city, and country) into one
combined_tab2s <- bind_rows(
  tab2s_neighbourhood %>%
    mutate(level = "Neighbourhood"),
  tab2s_city %>%
    mutate(level = "City"),
  tab2s_country %>%
    mutate(level = "Country")
)

# Create a custom order for the 'level' column to ensure Neighbourhood rows come first, then City, and then Country
combined_tab2s$level <- factor(combined_tab2s$level, levels = c("Neighbourhood", "City", "Country"))

# Sort the combined data by country, city, and the custom level order
tab2s_final <- combined_tab2s %>%
  arrange(country, city, level)

# Merge columns
tab2s_final <- tab2s_final %>%
  mutate(
    org_foodonly = paste0(count_org_vendors_foodonly, " (", round(org_vendor_perc_foodonly * 100, 2), "%)"),
    sentinels_foodonly = paste0(median_org_products_count_foodonly, " (", iqr_org_products_count_foodonly, ")")
  ) %>%
  select(country, city, circle, vendors, org_foodonly, sentinels_foodonly)

# Print table
print(tab2s_final)


# Export to table_outputs workbook
addWorksheet(table_outputs, "Table 2s")
writeData(table_outputs, sheet = "Table 2s", x = tab2s_final)
saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)

```



### Table S2

#### Exploratory Analysis: Hypothesis 1b. The count and proportion of vendors selling multiple organic options for at least one sentinel food will be highest in the United Kingdom, in larger cities within a given country, and in higher-income neighbourhoods within a given city.

##### For each neighbourhood within each city
```{r echo = FALSE, message = FALSE, warning = FALSE}
# N, %, median and IQR - neighbourhood level
tab3_neighbourhood_data <- data_clean %>%
  group_by(country, city, circle) %>%
  summarize(
    organic_vendors = sum(org_vendor == 1, na.rm = TRUE),
    n_multiple_org_binary = sum(multiple_org_binary == 1, na.rm = TRUE),
    perc_multiple_org_binary = n_multiple_org_binary / organic_vendors,
    median_multiple_org_count = median(multiple_org_count, na.rm = TRUE),
    iqr_multiple_org_count = IQR(multiple_org_count, na.rm = TRUE)
  ) %>%
  ungroup()

# Create the gt table
tab3_neighbourhood <- tab3_neighbourhood_data %>%
  gt(rowname_col = "circle", groupname_col = c("country","city")) %>%
  cols_label(
    country = "Country",
    city = "City",
    circle = "Neighbourhood",
    n_multiple_org_binary = "Organic vendors with multiple options (>1 product), n(%)",
    perc_multiple_org_binary = " ",
    median_multiple_org_count = "Foods with multiple options, median (IQR)",
    iqr_multiple_org_count = " "
  ) %>%
  fmt_percent(
    columns = vars(perc_multiple_org_binary),
    decimals = 0
  ) %>%
  cols_merge(
    columns = c("n_multiple_org_binary", "perc_multiple_org_binary"),
    pattern = "{1} ({2})"
  ) %>%
  cols_merge(
    columns = c("median_multiple_org_count", "iqr_multiple_org_count"),
    pattern = "{1} ({2})"
  ) %>%
  sub_missing() 
  
# Display the table
tab3_neighbourhood

# Export to table_outputs workbook
addWorksheet(table_outputs, "Table 3 - neighbourhood")
writeData(table_outputs, sheet = "Table 3 - neighbourhood", x = tab3_neighbourhood)
saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)

```

##### For each city within each country
```{r echo = FALSE, message = FALSE, warning = FALSE}
# N, %, median and IQR - city level
tab3_city_data <- data_clean %>%
  group_by(country, city) %>%
  summarize(
    organic_vendors = sum(org_vendor == 1, na.rm = TRUE),
    n_multiple_org_binary = sum(multiple_org_binary == 1, na.rm = TRUE),
    perc_multiple_org_binary = n_multiple_org_binary / organic_vendors,
    median_multiple_org_count = median(multiple_org_count, na.rm = TRUE),
    iqr_multiple_org_count = IQR(multiple_org_count, na.rm = TRUE)
  ) %>%
  ungroup()

# Create the gt table
tab3_city <- tab3_city_data %>%
  gt(rowname_col = "city", groupname_col = "country") %>%
  cols_label(
    country = "Country",
    city = "City",
    n_multiple_org_binary = "Organic vendors with multiple options (>1 product), n(%)",
    perc_multiple_org_binary = " ",
    median_multiple_org_count = "Foods with multiple options, median (IQR)",
    iqr_multiple_org_count = " "
  ) %>%
  fmt_percent(
    columns = vars(perc_multiple_org_binary),
    decimals = 0
  ) %>%
  cols_merge(
    columns = c("n_multiple_org_binary", "perc_multiple_org_binary"),
    pattern = "{1} ({2})"
  ) %>%
  cols_merge(
    columns = c("median_multiple_org_count", "iqr_multiple_org_count"),
    pattern = "{1} ({2})"
  ) %>%
  sub_missing() 
  
# Display the table
tab3_city

# Export to table_outputs workbook
addWorksheet(table_outputs, "Table 3 - city")
writeData(table_outputs, sheet = "Table 3 - city", x = tab3_city)
saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)
```

##### For each country
```{r echo = FALSE, message = FALSE, warning = FALSE}
# N, %, median and IQR - country level
tab3_country_data <- data_clean %>%
  group_by(country) %>%
  summarize(
    organic_vendors = sum(org_vendor == 1, na.rm = TRUE),
    n_multiple_org_binary = sum(multiple_org_binary == 1, na.rm = TRUE),
    perc_multiple_org_binary = n_multiple_org_binary / organic_vendors,
    median_multiple_org_count = median(multiple_org_count, na.rm = TRUE),
    iqr_multiple_org_count = IQR(multiple_org_count, na.rm = TRUE)
  ) %>%
  ungroup()

print(tab3_country_data)

# Export to table_outputs workbook
addWorksheet(table_outputs, "Table 3 - country")
writeData(table_outputs, sheet = "Table 3 - country", x = tab3_country_data)
saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)
```

##### Overall
```{r echo = FALSE, message = FALSE, warning = FALSE}
# N, %, median and IQR - overall
tab3_overall_data <- data_clean %>%
  summarize(
    organic_vendors = sum(org_vendor == 1, na.rm = TRUE),
    n_multiple_org_binary = sum(multiple_org_binary == 1, na.rm = TRUE),
    perc_multiple_org_binary = n_multiple_org_binary / organic_vendors,
    median_multiple_org_count = median(multiple_org_count, na.rm = TRUE),
    iqr_multiple_org_count = IQR(multiple_org_count, na.rm = TRUE)
  ) %>%
  ungroup()

print(tab3_overall_data)

# Export to table_outputs workbook
addWorksheet(table_outputs, "Table 3 - overall")
writeData(table_outputs, sheet = "Table 3 - overall", x = tab3_overall_data)
saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)

```

### Table S3 - Price of rice at same vendor

##### City-level

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Calculate number of organic and conventional vendors, median, IQR, min and max price
# Filtered on vendors with both organic and conventional rice
tabs1_city_data <- rice_prices_data %>%
  filter(rice_price_both == 1) %>%
  group_by(country, city) %>%
  summarise(
    count_org_rice_vendors = sum(!is.na(rice_price_org_kg_usd)),
    count_conv_rice_vendors = sum(!is.na(rice_price_conv_kg_usd)),
    median_org_rice = median(rice_price_org_kg_usd, na.rm = TRUE),
    iqr_org_rice = IQR(rice_price_org_kg_usd, na.rm = TRUE),
    min_org_rice = min(rice_price_org_kg_usd, na.rm = TRUE),
    max_org_rice = max(rice_price_org_kg_usd, na.rm = TRUE),
    median_conv_rice = median(rice_price_conv_kg_usd, na.rm = TRUE),
    iqr_conv_rice = IQR(rice_price_conv_kg_usd, na.rm = TRUE),
    min_conv_rice = min(rice_price_conv_kg_usd, na.rm = TRUE),
    max_conv_rice = max(rice_price_conv_kg_usd, na.rm = TRUE),
  ) %>%
  ungroup()

# Create the gt table
tabs1_city <- tabs1_city_data %>%
  gt(rowname_col = "city", groupname_col = c("country")) %>%
  cols_label(
    country = "Country",
    city = "City",
    count_org_rice_vendors = "Organic sample size (n)",
    count_conv_rice_vendors = "Conventional sample size (n)",
    median_org_rice = "Organic median (IQR), min-max (US$)",
    iqr_org_rice = " ",
    min_org_rice = " ",
    max_org_rice = " ",
    median_conv_rice = "Conventional median (IQR), min-max (US$)",
    iqr_conv_rice = " ",
    min_conv_rice = " ",
    max_conv_rice = " "
  ) %>%
  cols_merge(
    columns = c("median_org_rice", "iqr_org_rice", "min_org_rice", "max_org_rice"),
    pattern = "{1} ({2}), {3}-{4}"
  ) %>%
    cols_merge(
    columns = c("median_conv_rice", "iqr_conv_rice", "min_conv_rice", "max_conv_rice"),
    pattern = "{1} ({2}), {3}-{4}"
  ) %>%
  fmt_number(
    columns = vars(median_org_rice, iqr_org_rice, min_org_rice, max_org_rice,
                   median_conv_rice, iqr_conv_rice, min_conv_rice, max_conv_rice),
    decimals = 2
  ) %>%
  summary_rows(
    groups = everything(),
    columns = vars(count_org_rice_vendors,count_conv_rice_vendors),
    fns = list(total = ~sum(., na.rm = TRUE)),
    formatter = fmt_number,
    decimals = 0,
  ) %>%
  sub_missing() 
  
# Display the table
tabs1_city

# Export to table_outputs workbook
addWorksheet(table_outputs, "Table S1 - city")
writeData(table_outputs, sheet = "Table S1 - city", x = tabs1_city)
saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)

```

##### Country-level

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Calculate number of organic and conventional vendors, median, IQR, min and max price
# Filtered on vendors with both organic and conventional rice
tabs1_country_data <- rice_prices_data %>%
  filter(rice_price_both == 1) %>%
  group_by(country) %>%
  summarise(
    count_org_rice_vendors = sum(!is.na(rice_price_org_kg_usd)),
    count_conv_rice_vendors = sum(!is.na(rice_price_conv_kg_usd)),
    median_org_rice = median(rice_price_org_kg_usd, na.rm = TRUE),
    iqr_org_rice = IQR(rice_price_org_kg_usd, na.rm = TRUE),
    min_org_rice = min(rice_price_org_kg_usd, na.rm = TRUE),
    max_org_rice = max(rice_price_org_kg_usd, na.rm = TRUE),
    median_conv_rice = median(rice_price_conv_kg_usd, na.rm = TRUE),
    iqr_conv_rice = IQR(rice_price_conv_kg_usd, na.rm = TRUE),
    min_conv_rice = min(rice_price_conv_kg_usd, na.rm = TRUE),
    max_conv_rice = max(rice_price_conv_kg_usd, na.rm = TRUE),
  ) %>%
  ungroup()

tabs1_country <- tabs1_country_data %>%
  gt() %>%
  cols_label(
    country = "Country",
    count_org_rice_vendors = "Organic sample size (n)",
    count_conv_rice_vendors = "Conventional sample size (n)",
    median_org_rice = "Organic median (IQR), min-max (US$)",
    iqr_org_rice = " ",
    min_org_rice = " ",
    max_org_rice = " ",
    median_conv_rice = "Conventional median (IQR), min-max (US$)",
    iqr_conv_rice = " ",
    min_conv_rice = " ",
    max_conv_rice = " "
  ) %>%
  cols_merge(
    columns = c("median_org_rice", "iqr_org_rice", "min_org_rice", "max_org_rice"),
    pattern = "{1} ({2}), {3}-{4}"
  ) %>%
    cols_merge(
    columns = c("median_conv_rice", "iqr_conv_rice", "min_conv_rice", "max_conv_rice"),
    pattern = "{1} ({2}), {3}-{4}"
  ) %>%
  fmt_number(
    columns = vars(median_org_rice, iqr_org_rice, min_org_rice, max_org_rice,
                   median_conv_rice, iqr_conv_rice, min_conv_rice, max_conv_rice),
    decimals = 2
  ) %>%
  grand_summary_rows(
    columns = vars(count_org_rice_vendors,count_conv_rice_vendors),
    fns = list(total = ~sum(., na.rm = TRUE)),
    formatter = fmt_number,
    decimals = 0,
  ) %>%
  sub_missing() 

# Display the table
tabs1_country

# Export to table_outputs workbook
addWorksheet(table_outputs, "Table S1 - country")
writeData(table_outputs, sheet = "Table S1 - country", x = tabs1_country)
saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)


```


##### Overall

```{r echo = FALSE, message = FALSE, warning = FALSE}

# Calculate number of organic and conventional vendors, median, IQR, min and max price
# Filtered on vendors with both organic and conventional rice
tabs1_overall_data <- rice_prices_data %>%
  filter(rice_price_both == 1) %>%
  summarise(
    count_org_rice_vendors = sum(!is.na(rice_price_org_kg_usd)),
    count_conv_rice_vendors = sum(!is.na(rice_price_conv_kg_usd)),
    median_org_rice = median(rice_price_org_kg_usd, na.rm = TRUE),
    iqr_org_rice = IQR(rice_price_org_kg_usd, na.rm = TRUE),
    min_org_rice = min(rice_price_org_kg_usd, na.rm = TRUE),
    max_org_rice = max(rice_price_org_kg_usd, na.rm = TRUE),
    median_conv_rice = median(rice_price_conv_kg_usd, na.rm = TRUE),
    iqr_conv_rice = IQR(rice_price_conv_kg_usd, na.rm = TRUE),
    min_conv_rice = min(rice_price_conv_kg_usd, na.rm = TRUE),
    max_conv_rice = max(rice_price_conv_kg_usd, na.rm = TRUE),
  ) %>%
  ungroup()

tabs1_overall <- tabs1_overall_data %>%
  gt() %>%
  cols_label(
    count_org_rice_vendors = "Organic sample size (n)",
    count_conv_rice_vendors = "Conventional sample size (n)",
    median_org_rice = "Organic median (IQR), min-max (US$)",
    iqr_org_rice = " ",
    min_org_rice = " ",
    max_org_rice = " ",
    median_conv_rice = "Conventional median (IQR), min-max (US$)",
    iqr_conv_rice = " ",
    min_conv_rice = " ",
    max_conv_rice = " "
  ) %>%
  cols_merge(
    columns = c("median_org_rice", "iqr_org_rice", "min_org_rice", "max_org_rice"),
    pattern = "{1} ({2}), {3}-{4}"
  ) %>%
    cols_merge(
    columns = c("median_conv_rice", "iqr_conv_rice", "min_conv_rice", "max_conv_rice"),
    pattern = "{1} ({2}), {3}-{4}"
  ) %>%
  fmt_number(
    columns = vars(median_org_rice, iqr_org_rice, min_org_rice, max_org_rice,
                   median_conv_rice, iqr_conv_rice, min_conv_rice, max_conv_rice),
    decimals = 2
  ) %>%
  sub_missing() 

# Display the table
tabs1_overall

# Export to table_outputs workbook
addWorksheet(table_outputs, "Table S1 - overall")
writeData(table_outputs, sheet = "Table S1 - overall", x = tabs1_overall)
saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)


```





### Table S4 - Vendors closed or refused

```{r echo = FALSE, message = FALSE, warning = FALSE}


# Load data on closed vendors
closed_data <- read.xlsx("~/GitHub/fea/Outputs/proceed_data_formatted_27.11.24.xlsx", sheet = "proceed_data")

# Summarise closed vendors
tab_closed <- closed_data %>%
  select(country, city, proceed) %>%
  group_by(country, city, proceed) %>%
  count() %>%
  pivot_wider(
    names_from = proceed,
    values_from = n,
    values_fill = list(n = 0)  # Fill missing counts with 0
  )

# Summarise proceed column - note that this includes only 'Yes' to proceed because rest was deleted in data cleaning process
tab_open <- data_clean %>%
  select(country, city, proceed) %>%
  group_by(country, city, proceed) %>%
  count() %>%
  pivot_wider(
    names_from = proceed,
    values_from = n,
    values_fill = list(n = 0)  # Fill missing counts with 0
  )

# Combine tables and aggregate
combined_tab_proceed <- bind_rows(
  tab_closed,
  tab_open
) %>%
  group_by(country, city) %>%
  summarise(
    across(starts_with("Yes"), sum, na.rm = TRUE),  # Sum up the 'Yes' values
    across(starts_with("No"), sum, na.rm = TRUE),  # Sum up the 'No' values
    across(starts_with("NA"), sum, na.rm = TRUE))  # Sum up the 'No' values


# Export to table_outputs workbook
addWorksheet(table_outputs, "Table S3")
writeData(table_outputs, sheet = "Table S3", x = combined_tab_proceed)
saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)
```


### Table SX - Certification frequency by terminology - WORK IN PROGRESS!

```{r echo = FALSE, message = FALSE, warning = FALSE}

# values per country
country <- data_clean %>%
  group_by(country) %>%
  summarise(Certified = sum(cert_count, na.rm = TRUE),
            Total = sum(org_products_count, na.rm = TRUE)) %>%
  mutate(Proportion = round(Certified/Total*100, 2)) %>%
  bind_rows(
    summarise(., 
              country = "Total", 
              Certified = sum(Certified), 
              Total = sum(Total), 
              Proportion = round(sum(Certified) / sum(Total) * 100, 2))
    )

# values per store type
vendortype <- data_clean %>%
  group_by(vendor_type)%>%
  summarise(Certified = sum(cert_count, na.rm = TRUE),
            Total = sum(org_products_count, na.rm = TRUE)) %>%
  mutate(Proportion = round(Certified/Total*100, 2))


# values per food
products <- c("tom", "leaf", "ban", "man", "fj", "milk", "cof", "tea", "mill", "chic", "daal", "wht", "rice", "nut")
vector_organics <- paste0(products, "_org")
vector_cert <- paste0(products, "_cert")


sentinelfood <- cbind(
  # count certifications
  data_clean %>%
    select(id, country, all_of(vector_cert)) %>%
    pivot_longer(cols = c(vector_cert), 
                 names_to = "food", 
                 values_to = c("certified")) %>%
    group_by(food) %>%
    summarise(Certified = sum(certified >= 1, na.rm=T)),
  
  # count all organics
  data_clean %>%
    select(id, country, all_of(vector_organics)) %>%
    pivot_longer(cols = c(vector_organics), 
                 names_to = "food", 
                 values_to = c("total")) %>%
    group_by(food) %>%
    summarise(Total = sum(total == "Yes", na.rm=T)) %>%
    select(-food)
) %>%
  mutate(Proportion = round(Certified/Total*100, 2))

kable(country)
kable(vendortype)
kable(sentinelfood)


# Export to table_outputs workbook
addWorksheet(table_outputs, "Table 8 - country")
writeData(table_outputs, sheet = "Table 8 - country", x = country)

addWorksheet(table_outputs, "Table 8 - vendortype")
writeData(table_outputs, sheet = "Table 8 - vendortype", x = vendortype)

addWorksheet(table_outputs, "Table 8 - sentinelfood")
writeData(table_outputs, sheet = "Table 8 - sentinelfood", x = sentinelfood)

saveWorkbook(table_outputs, "C:/Users/s1985751/Documents/GitHub/fea/table_outputs.xlsx", overwrite = TRUE)
```











